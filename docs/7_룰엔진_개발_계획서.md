# 룰엔진 개발 계획서

**작성일**: 2025-12-30

---

## 1. 개요

### 1.1 목적

| 항목 | 내용 |
|------|------|
| 목표 | 환자가 3~6개 검사 처방 시, 규칙 위배 없는 검사 시간 추천 |
| 입력 | 검사 코드 목록, 환자 프로필 |
| 시작일 | 입력 당일 기준 (별도 지정 없음) |
| 출력 | 검사별 추천 일시, 안내 메시지 |

### 1.2 처리 규칙

| 규칙 유형 | 개수 | 데이터 소스 | 처리 내용 |
|----------|------|------------|----------|
| RELATION | 64개 | EXAM_RELATION_RULES_data.csv | 당일불가, 순서, 간격 |
| CONDITION | 54개 | EXAM_CONDITION_RULES_data.csv | 검증, 안내 생성 |
| ATTRIBUTE | 21개 | EXAM_MASTER_data.csv | 운영시간, 소요시간 |
| **합계** | **139개** | - | - |

---

## 2. 규칙 우선순위 (3-Layer)

### 2.1 Layer 구조

| Layer | 구분 | 성격 | 위반 시 |
|-------|------|------|---------|
| **L1** | 필수 규칙 (Hard Constraint) | 절대 위반 불가 | 스케줄 실패 |
| **L2** | 권장 사항 (Soft Constraint) | 기본 적용, 조정 가능 | 차선책 제시 |
| **L3** | 환자 선호 (Preference) | 요청에 따라 적용 | L1 범위 내 조정 |

### 2.2 처리 흐름

```
1단계: L1 필수 규칙으로 "가능한 슬롯" 필터링
       → 위반 시 스케줄 자체가 불가능
       → 결과: 유효 슬롯 집합

2단계: L2 권장 사항으로 "최적 슬롯" 정렬/점수화
       → 기본 최적화 적용
       → 결과: 점수순 정렬된 슬롯

3단계: L3 환자 선호로 "최종 슬롯" 조정
       → L1 위반하지 않는 범위 내에서 조정
       → 결과: 최종 추천 스케줄
```

### 2.3 L1: 필수 규칙 (Hard Constraint)

**위반 시 스케줄 불가 - 반드시 준수**

| 분류 | 규칙 | 데이터 소스 |
|------|------|-------------|
| 당일 불가 | SAME_DAY_CD=N인 검사 쌍은 다른 날 배정 | EXAM_RELATION_RULES |
| 순서 필수 | SEQ_REQ_YN=Y면 EXAM_A → EXAM_B 순서 | EXAM_RELATION_RULES |
| 간격 필수 | GAP_VALUE/UNIT 만큼 간격 확보 | EXAM_RELATION_RULES |
| 운영 시간 | AVAIL_START/END_TIME 내 배정 | EXAM_MASTER |
| 소요 시간 | DURATION_MIN 만큼 슬롯 확보 | EXAM_MASTER |
| 자원 충돌 | 동일 자원 동일 시간 중복 배정 불가 | RESOURCE_data |
| 일요일 불가 | 일요일 예약 불가 | 시스템 규칙 |
| 주말 불가 (특정 검사) | ACTION_CD=NOWEEKEND인 검사 | EXAM_CONDITION_RULES |
| 시간대 제한 | ACTION_CD=TIMEONLY인 검사 | EXAM_CONDITION_RULES |

### 2.4 L2: 권장 사항 (Soft Constraint)

**기본 적용되나, 불가 시 차선책 가능**

| 분류 | 규칙 | 점수 가중치 |
|------|------|-------------|
| 이동시간 | 장비 유형 다르면 +10분 버퍼 | +10점 |
| 연속 배치 | 같은 날 검사는 대기시간 최소화하여 연속 | +20점 |
| 금식 오전 | FASTING_HRS > 0인 검사는 오전 우선 | +15점 |
| 방문일 최소화 | 가능하면 적은 방문일로 묶기 | +25점 |
| 조영제 순서 | 조영제 검사는 비조영제 후 배정 | +10점 |
| 진정검사 후 | 진정검사 후에는 일반 검사 배정 | +10점 |

**점수 계산 예시**:
```
슬롯 A: 연속배치(+20) + 금식오전(+15) = 35점
슬롯 B: 이동시간확보(+10) = 10점
→ 슬롯 A 우선 추천
```

### 2.5 L3: 환자 선호 (Preference)

**향후 확장 - 환자 요청 반영**

| 선호 유형 | 예시 | 처리 방식 |
|----------|------|----------|
| 요일 선호 | "화/목 선호" | 해당 요일 슬롯 점수 가산 |
| 요일 기피 | "금요일 피해주세요" | 해당 요일 슬롯 제외 (L1 위반 아니면) |
| 시간대 선호 | "오전 선호" | 오전 슬롯 점수 가산 |
| 특정일 피하기 | "12/25 피해주세요" | 해당일 제외 |
| 최소 방문 | "하루에 몰아서" | 방문일 최소화 점수 극대화 |
| 여유 있게 | "하루 1개씩" | 일별 분산 배정 |

**입력 확장 (향후)**:
```python
class PatientPreference:
    preferred_days: List[str]      # ["화", "목"]
    avoided_days: List[str]        # ["금"]
    preferred_time: str            # "오전" | "오후" | None
    avoided_dates: List[date]      # [2025-12-25]
    visit_style: str               # "compact" | "spread" | None
```

### 2.6 Layer 간 상호작용

```
예시: 환자가 "금요일 피해주세요" 요청

L1 검사: CT조영 → PET 3일 간격 (필수)
L2 적용: 방문일 최소화
L3 적용: 금요일 제외

Case 1: CT 월요일 → PET 목요일 (L1 충족, L3 충족) ✓
Case 2: CT 화요일 → PET 금요일 (L1 충족, L3 위반)
        → L3 조정: PET 토요일로 변경 (L1 범위 내)

Case 3: 금요일 외 불가한 경우
        → 경고: "금요일 피할 수 없음, 진행할까요?"
```

---

## 3. 시스템 구조

### 3.1 모듈 구성

```
src/rule_engine/
├── __init__.py
├── loader.py           # 데이터 로더
├── models.py           # 데이터 모델 (Exam, Patient, Schedule)
├── relation_checker.py # RELATION 규칙 처리
├── condition_checker.py# CONDITION 규칙 처리
├── scheduler.py        # 스케줄 추천 엔진
└── engine.py           # 통합 엔진 (메인 인터페이스)
```

### 3.2 데이터 흐름

```
[입력]                    [처리]                      [출력]
검사 코드 목록 ─┐
희망 시작일 ────┼──▶ RuleEngine ──▶ 추천 스케줄
환자 정보 ──────┘         │              │
                         ▼              ▼
                    규칙 검증       안내 메시지
```

---

## 4. 입출력 설계

### 4.1 입력 스펙

```python
# 검사 요청
class ExamRequest:
    exam_codes: List[str]      # 검사 코드 목록 (3~6개)
    patient: PatientInfo       # 환자 프로필
    # 시작일: 입력 당일 자동 설정 (date.today())

# 환자 프로필 (CONDITION 규칙용)
class PatientInfo:
    age: int                   # 나이
    medications: List[str]     # 복용 약물
    allergies: List[str]       # 알레르기
    diseases: List[str]        # 질환
    devices: List[str]         # 의료기기 (심박동기 등)
    is_pregnant: bool          # 임신 여부
```

### 4.2 출력 스펙

```python
# 추천 결과
class ScheduleResult:
    schedules: List[ExamSchedule]  # 검사별 추천 일시
    notices: List[Notice]          # 안내 메시지
    is_valid: bool                 # 전체 유효성

# 개별 검사 스케줄
class ExamSchedule:
    exam_cd: str               # 검사 코드
    exam_nm: str               # 검사명
    scheduled_date: date       # 예약일
    scheduled_time: time       # 예약 시간
    duration_min: int          # 소요시간
    end_time: time             # 종료 시간

# 안내 메시지
class Notice:
    exam_cd: str               # 대상 검사
    notice_type: str           # FASTING, STOPMED, GUARD 등
    message: str               # 안내 내용
```

---

## 5. 규칙 처리 상세

### 5.1 RELATION 규칙 (스케줄링)

| 규칙 유형 | 컬럼 | 처리 로직 |
|----------|------|----------|
| 당일 불가 | SAME_DAY_CD=N | 다른 날짜로 배정 |
| 당일 가능 | SAME_DAY_CD=Y | 같은 날 배정 가능 |
| 조건부 가능 | SAME_DAY_CD=C | 간격 조건 충족 시 당일 가능 |
| 순서 필수 | SEQ_REQ_YN=Y | EXAM_A → EXAM_B 순서 보장 |
| 간격 필요 | GAP_VALUE, GAP_UNIT | A 후 N일/시간/분 후 B |
| 역방향 간격 | REV_GAP_VALUE | B → A 방향 간격 |

**처리 예시**:
```
입력: [CT조영, PET-CT, 초음파]
규칙: CT조영 → PET-CT 2일 간격

결과:
  Day 1: CT조영 09:00, 초음파 10:00
  Day 3: PET-CT 09:00
```

### 5.2 ATTRIBUTE 규칙 (시간 계산)

| 속성 | 컬럼 | 처리 로직 |
|------|------|----------|
| 운영 시간 | AVAIL_START_TIME, AVAIL_END_TIME | 가용 시간대 필터 |
| 소요 시간 | DURATION_MIN | 슬롯 계산, 종료 시간 |
| 금식 시간 | FASTING_HRS | 금식 검사 오전 우선 배정 |
| 조영제 | CONTRAST_YN | 관계 규칙 적용 대상 |
| 진정 검사 | SEDATION_YN | 당일 1회 제한 |

**처리 예시**:
```
입력: Heart MRI (AVAIL: 08:00~17:00, DURATION: 120분)
결과: 08:00~10:00, 10:00~12:00, 13:00~15:00, 15:00~17:00 슬롯
```

### 5.3 CONDITION 규칙 (검증/안내)

| ACTION_CD | 처리 유형 | 처리 내용 |
|-----------|----------|----------|
| NOWEEKEND | 스케줄링 | 토/일 예약 불가 |
| TIMEONLY | 스케줄링 | 특정 시간대만 가능 |
| GUARD | 안내 | "보호자 동반 필요" 출력 |
| FASTING | 안내 | "N시간 금식 필요" 출력 |
| STOPMED | 안내 | "약물 N시간 전 중단" 출력 |
| CONSENT | 안내 | "동의서 필요" 출력 |
| PRETEST | 안내 | "사전 검사 필요" 출력 |
| ALLOWED | 정보 | 허용 사항 안내 |

**처리 예시**:
```
입력: CT조영, 환자 age=14
규칙: AGE < 15 → GUARD

결과:
  스케줄: CT조영 09:00
  안내: "만 15세 미만 환자 - 보호자 동반 필요"
```

---

## 6. 스케줄링 알고리즘

### 6.1 기본 전략

```
1. 검사 정렬 (선행 검사 우선)
2. 첫 검사 배정 (희망일 첫 슬롯)
3. 후속 검사 배정
   - RELATION 규칙 확인
   - 당일 가능 → 같은 날 다음 슬롯
   - 당일 불가/간격 필요 → 다음 가능일
4. 안내 메시지 수집
5. 결과 반환
```

### 6.2 검사 정렬 규칙

| 우선순위 | 조건 | 이유 |
|---------|------|------|
| 1 | 금식 검사 (FASTING_HRS > 0) | 오전 배정 필요 |
| 2 | 조영제 검사 (CONTRAST_YN=Y) | 후속 검사 간격 영향 |
| 3 | 진정 검사 (SEDATION_YN=Y) | 당일 1회 제한 |
| 4 | 순서 필수 선행 검사 (SEQ_REQ_YN=Y의 EXAM_A) | 먼저 배정 |
| 5 | 일반 검사 | 나머지 |

### 6.3 슬롯 계산

```
운영 시간: EXAM_MASTER의 AVAIL_START/END_TIME 참조
           - 기본: 08:00 ~ 17:00
           - NULL인 경우: 08:00 ~ 17:00 적용
슬롯 단위: 10분 (RESERVATION_data.csv 기준)
자원 데이터: RESOURCE_data.csv (37대)
예약 데이터: RESERVATION_data.csv (기존 예약 충돌 확인)

예시 (30분 검사, CT):
  가용 자원: CT_01, CT_02, CT_03, CT_04
  가용 슬롯: 08:00, 08:10, 08:20, 08:30, ...
  기존 예약과 충돌 없는 슬롯 추천
```

### 6.4 특수 운영시간 처리

| 검사 | AVAIL_START | AVAIL_END | 처리 방식 |
|------|-------------|-----------|----------|
| PSG (수면다원검사) | 21:00 | 06:00 | 야간 슬롯 (일자 경계 처리) |
| MSLT (주간졸림검사) | 08:30 | 17:00 | PSG 다음날 고정 배정 |
| 일반 검사 | NULL | NULL | 08:00 ~ 17:00 기본 적용 |
| 개별 지정 | HH:MM | HH:MM | 지정 시간대만 가용 |

**야간 검사 처리 로직**:
```
if AVAIL_START > AVAIL_END:  # 예: 21:00 > 06:00
    # 일자 경계를 넘는 검사
    슬롯 = [당일 21:00~23:50] + [익일 00:00~06:00]
    예약일 = 시작일 (종료는 익일)
```

**PSG-MSLT 연계 처리**:
```
if PSG in exam_codes and MSLT in exam_codes:
    # RELATION 규칙: PSG → MSLT 1일 간격, 순서 필수
    PSG: Day N, 21:00
    MSLT: Day N+1, 08:30 (AVAIL_START_TIME 고정)
```

---

## 7. 개발 단계

### Phase 1: 기반 구축

| 작업 | 산출물 |
|------|--------|
| 데이터 모델 정의 | models.py |
| CSV 로더 구현 | loader.py |
| 단위 테스트 | test_loader.py |

### Phase 2: 규칙 처리기

| 작업 | 산출물 |
|------|--------|
| RELATION 규칙 처리 | relation_checker.py |
| CONDITION 규칙 처리 | condition_checker.py |
| 단위 테스트 | test_checkers.py |

### Phase 3: 스케줄러

| 작업 | 산출물 |
|------|--------|
| 슬롯 계산 로직 | scheduler.py |
| 스케줄 추천 알고리즘 | scheduler.py |
| 통합 테스트 | test_scheduler.py |

### Phase 4: 통합

| 작업 | 산출물 |
|------|--------|
| 메인 엔진 통합 | engine.py |
| CLI 인터페이스 | main.py |
| 통합 테스트 | test_engine.py |

---

## 8. 테스트 시나리오

### 8.1 기본 시나리오

| 시나리오 | 입력 | 예상 결과 |
|---------|------|----------|
| 단순 3개 검사 | CT, MRI, 초음파 | 같은 날 순차 배정 |
| 당일 불가 | CT조영, PET-CT | 다른 날 배정 |
| 순서 필수 | 위내시경, 대장내시경 | 위→대장 순서 |
| 간격 필요 | CT조영, BMD | 3일 간격 |

### 8.2 복합 시나리오

| 시나리오 | 입력 | 예상 결과 |
|---------|------|----------|
| 금식+조영제 | CT조영, MRI조영, PET-CT | 금식 오전, 간격 준수 |
| 소아 환자 | CT, MRI (age=10) | 스케줄 + 보호자동반 안내 |
| 약물 복용 | PET-CT (Metformin) | 스케줄 + 약물중단 안내 |
| 주말 제한 | 핵의학 (토요일) | 평일로 변경 |

### 8.3 엣지 케이스

| 시나리오 | 입력 | 예상 결과 |
|---------|------|----------|
| 순환 의존 | A→B, B→A | 오류 또는 우선순위 적용 |
| 불가능 조합 | 상충 규칙 | 오류 메시지 |
| 빈 입력 | [] | 빈 결과 |
| 6개 초과 | 7개 검사 | 경고 또는 분할 |

---

## 9. 사용 예시

### 9.1 기본 사용

```python
from rule_engine import RuleEngine

# 엔진 초기화
engine = RuleEngine(data_path="./data")

# 검사 요청 (시작일은 오늘 자동 적용)
result = engine.recommend_schedule(
    exam_codes=["RC060003", "NM020003", "RU010003"],  # CT조영, PET-CT, 복부초음파
    patient={"age": 45}
)

# 결과 출력
for schedule in result.schedules:
    print(f"{schedule.exam_nm}: {schedule.scheduled_date} {schedule.scheduled_time}")

for notice in result.notices:
    print(f"[{notice.notice_type}] {notice.message}")
```

### 9.2 예상 출력

```
=== 추천 스케줄 ===
1. 복부초음파: 2025-01-06 08:00 (30분)
2. CT조영(복부): 2025-01-06 08:30 (20분)
3. PET-CT: 2025-01-09 09:00 (30분)  ← CT조영 후 3일 간격

=== 안내 사항 ===
[FASTING] CT조영(복부): 검사 전 8시간 금식 필요
[FASTING] PET-CT: 검사 전 6시간 금식 필요
[CONTRAST] CT조영(복부): 조영제 사용 검사입니다
```

---

## 10. 파일 구조

```
검사규칙 합성데이터/
├── src/
│   └── rule_engine/
│       ├── __init__.py
│       ├── loader.py
│       ├── models.py
│       ├── relation_checker.py
│       ├── condition_checker.py
│       ├── scheduler.py
│       └── engine.py
├── tests/
│   └── rule_engine/
│       ├── test_loader.py
│       ├── test_checkers.py
│       ├── test_scheduler.py
│       └── test_engine.py
├── data/
│   ├── EXAM_MASTER_data.csv
│   ├── EXAM_RELATION_RULES_data.csv
│   └── EXAM_CONDITION_RULES_data.csv
└── docs/
    └── 7_룰엔진_개발_계획서.md
```

---

## 11. 제약 사항

| 항목 | 제약 |
|------|------|
| 검사 개수 | 3~6개 권장 (최대 10개) |
| 스케줄 기간 | 입력 당일로부터 최대 30일 |
| 슬롯 단위 | 10분 |
| 자원 배정 | RESOURCE_data.csv 기반 |
| 예약 충돌 | RESERVATION_data.csv 기반 확인 |

---

## 12. 자원 현황

### 12.1 장비별 자원 (RESOURCE_data.csv)

| 장비 유형 | 대수 | 자원 ID |
|----------|------|---------|
| CT | 4대 | CT_01 ~ CT_04 |
| MRI | 5대 | MRI_01 ~ MRI_05 |
| US | 4대 | US_01 ~ US_04 |
| NM | 4대 | NM_01 ~ NM_04 |
| ENDO | 5대 | ENDO_01 ~ ENDO_05 |
| FLUORO | 3대 | FLUORO_01 ~ FLUORO_03 |
| FUNC | 8대 | FUNC_01 ~ FUNC_08 |
| XRAY | 3대 | XRAY_01 ~ XRAY_03 |
| **합계** | **37대** | - |

---

## 13. 향후 확장

| 항목 | 내용 | Layer |
|------|------|-------|
| L2 최적화 고도화 | 점수 가중치 튜닝, 학습 기반 최적화 | L2 |
| L3 환자 선호 구현 | 요일/시간대 선호, 방문 스타일 | L3 |
| API 제공 | REST API 형태로 제공 | - |
| 실시간 연동 | 실제 HIS 시스템 연동 | - |
