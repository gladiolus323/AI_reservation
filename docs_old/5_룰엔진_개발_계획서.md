# 검사 예약 룰 엔진 개발 계획서

## 1. 개요

### 1.1 목적
병원 검사 예약 시스템에서 **복잡한 규칙들을 자동으로 검증하고 적용**하는 룰 엔진을 개발한다.

### 1.2 룰 엔진이란?
```
IF 조건 충족 → THEN 행동 실행
```
- 예: `IF 환자 나이 < 19세 + CT 조영제 검사 → THEN 보호자 동반 필수`

### 1.3 현재 스키마 구조

| 테이블 | 설명 | 레코드 수 |
|--------|------|-----------|
| EXAM_MASTER | 검사 기본 정보 (265개 검사) | 265 |
| EXAM_RELATION_RULES | 검사 간 관계/간격 규칙 | 87 |
| EXAM_CONDITION_RULES | 조건부 예외 규칙 | 48 |
| RESERVATION | 예약 데이터 | 10,000+ |
| RESOURCE | 장비 정보 | 37 |

---

## 2. 룰 엔진 아키텍처

### 2.1 전체 구조

```
┌─────────────────────────────────────────────────────────────┐
│                      룰 엔진 (Rule Engine)                    │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────┐   ┌──────────────┐   ┌──────────────┐     │
│  │  Rule Loader │   │ Rule Parser  │   │Rule Executor │     │
│  │  (규칙 로더)  │ → │ (규칙 파서)   │ → │ (규칙 실행)   │     │
│  └──────────────┘   └──────────────┘   └──────────────┘     │
│         ↑                                      ↓              │
│  ┌──────────────┐                      ┌──────────────┐     │
│  │  CSV 파일들   │                      │ 검증 결과     │     │
│  │ (규칙 정의)   │                      │ (Validation) │     │
│  └──────────────┘                      └──────────────┘     │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 모듈 구성

```
src/
├── rule_engine/
│   ├── __init__.py
│   ├── loader.py          # 규칙 CSV 로드
│   ├── parser.py          # 규칙 파싱/해석
│   ├── executor.py        # 규칙 실행
│   ├── validator.py       # 예약 검증
│   └── reporter.py        # 결과 리포트
│
├── rules/
│   ├── relation_rules.py  # 검사 간 관계 규칙
│   ├── condition_rules.py # 조건부 규칙
│   └── time_rules.py      # 시간 관련 규칙
│
├── models/
│   ├── exam.py            # 검사 모델
│   ├── patient.py         # 환자 모델
│   └── reservation.py     # 예약 모델
│
└── utils/
    ├── time_utils.py      # 시간 계산 유틸
    └── gap_calculator.py  # 간격 계산기
```

---

## 3. 규칙 유형별 구현 계획

### 3.1 관계 규칙 (EXAM_RELATION_RULES)

**목적**: 검사 A와 검사 B 간의 관계/간격을 정의

#### 규칙 예시
| EXAM_A | EXAM_B | GAP_VALUE | GAP_UNIT | REASON_CD |
|--------|--------|-----------|----------|-----------|
| RC060003 | RX010001 | 3 | D | CONTRAST |
| SC030010 | RC060003 | 60 | M | SEDATION |

#### 구현 로직
```python
class RelationRule:
    def check(self, exam_a: Reservation, exam_b: Reservation) -> ValidationResult:
        """
        두 검사 간 간격 규칙 검증

        예시: CT 조영제(RC060003) 후 BMD(RX010001) → 3일 간격 필요
        """
        # 1. 순서 확인 (SEQ_REQ_YN)
        if self.seq_required and exam_a.datetime > exam_b.datetime:
            return ValidationResult(False, "순서 위반: A가 B보다 먼저 시행되어야 함")

        # 2. 당일 시행 가능 여부 (SAME_DAY_CD)
        if self.same_day_cd == 'N' and same_day(exam_a, exam_b):
            return ValidationResult(False, "당일 시행 불가")

        # 3. 간격 확인 (GAP_VALUE, GAP_UNIT)
        actual_gap = calculate_gap(exam_a, exam_b)
        required_gap = self.convert_to_minutes(self.gap_value, self.gap_unit)

        if actual_gap < required_gap:
            return ValidationResult(False, f"간격 부족: {required_gap}분 필요, 현재 {actual_gap}분")

        return ValidationResult(True, "규칙 충족")
```

#### REASON_CD 처리

| 코드 | 의미 | 처리 방법 |
|------|------|-----------|
| CONTRAST | 조영제 배출 대기 | 시간 간격 엄격 적용 |
| FASTING | 금식 필요 | 검사 순서 최적화 |
| BOWEL | 장 정결 필요 | 준비 시간 고려 |
| SEDATION | 진정 회복 대기 | 회복실 시간 포함 |
| RADIATION | 방사선 노출 제한 | 일별 누적 체크 |

---

### 3.2 조건 규칙 (EXAM_CONDITION_RULES)

**목적**: 특정 조건에서 추가 조치가 필요한 경우 정의

#### 규칙 예시
| RULE_ID | EXAM_CD | COND_TYPE | COND_OP | COND_VAL | ACTION_CD | ACTION_VAL |
|---------|---------|-----------|---------|----------|-----------|------------|
| R001 | RC060003 | AGE | < | 19 | GUARD | 보호자동반필수 |
| R006 | RC060003 | MED | STOP | Metformin | STOPMED | CT전후 2일 중단 |

#### COND_TYPE 별 구현

```python
class ConditionEvaluator:
    """조건 평가기"""

    def evaluate(self, cond_type: str, cond_op: str, cond_val: str,
                 patient: Patient, reservation: Reservation) -> bool:

        evaluators = {
            'AGE': self._eval_age,
            'MED': self._eval_medication,
            'ALLERGY': self._eval_allergy,
            'PREG': self._eval_pregnancy,
            'DISEASE': self._eval_disease,
            'DEVICE': self._eval_device,
            'WEEKDAY': self._eval_weekday,
            'INTERVAL': self._eval_interval,
        }

        return evaluators[cond_type](cond_op, cond_val, patient, reservation)

    def _eval_age(self, op, val, patient, reservation):
        """나이 조건 평가"""
        age = patient.age
        val = float(val)

        ops = {
            '<': age < val,
            '<=': age <= val,
            '>': age > val,
            '>=': age >= val,
            '=': age == val,
        }
        return ops[op]

    def _eval_weekday(self, op, val, patient, reservation):
        """요일 조건 평가"""
        weekday = reservation.reservation_date.strftime('%A')
        weekday_kr = {
            'Monday': '월', 'Tuesday': '화', 'Wednesday': '수',
            'Thursday': '목', 'Friday': '금', 'Saturday': '토', 'Sunday': '일'
        }

        if op == 'IN':
            # val = "토/일"
            return weekday_kr[weekday] in val.split('/')
        elif op == '=':
            return weekday_kr[weekday] == val

        return False
```

#### ACTION_CD 별 처리

| 코드 | 의미 | 처리 방법 |
|------|------|-----------|
| GUARD | 보호자 동반 | 예약 시 알림 플래그 설정 |
| NOWEEKEND | 주말 불가 | 주말 예약 차단 |
| TIMEONLY | 시간 제한 | 해당 시간대만 예약 가능 |
| FASTING | 금식 조정 | 금식 시간 정보 업데이트 |
| CONSENT | 동의 필요 | 동의서 필요 플래그 설정 |
| PRETEST | 사전 검사 | 선행 검사 확인 |
| STOPMED | 약물 중단 | 약물 중단 안내 생성 |

---

### 3.3 시간 규칙 (EXAM_MASTER 기반)

**목적**: 검사별 운영 시간 제한

#### 구현 로직
```python
class TimeRule:
    def check(self, exam: ExamMaster, reservation_time: datetime) -> ValidationResult:
        """
        검사 가능 시간대 검증

        예시: PSG(수면다원검사) → 21:00~06:00만 가능
        """
        if exam.avail_start_time is None:
            return ValidationResult(True, "시간 제한 없음")

        start = parse_time(exam.avail_start_time)  # 21:00
        end = parse_time(exam.avail_end_time)      # 06:00
        current = reservation_time.time()

        # 야간 시간대 처리 (21:00 ~ 06:00)
        if start > end:
            is_valid = current >= start or current <= end
        else:
            is_valid = start <= current <= end

        if not is_valid:
            return ValidationResult(False,
                f"예약 불가 시간: {exam.avail_start_time}~{exam.avail_end_time}만 가능")

        return ValidationResult(True, "시간 규칙 충족")
```

---

## 4. 핵심 클래스 설계

### 4.1 RuleEngine (메인 엔진)

```python
class RuleEngine:
    """
    검사 예약 룰 엔진

    사용 예시:
        engine = RuleEngine()
        engine.load_rules('data/')
        result = engine.validate_reservation(reservation, patient)
    """

    def __init__(self):
        self.relation_rules: List[RelationRule] = []
        self.condition_rules: List[ConditionRule] = []
        self.exam_master: Dict[str, ExamMaster] = {}

    def load_rules(self, data_path: str):
        """CSV에서 규칙 로드"""
        self.exam_master = load_exam_master(f"{data_path}/EXAM_MASTER.csv")
        self.relation_rules = load_relation_rules(f"{data_path}/EXAM_RELATION_RULES.csv")
        self.condition_rules = load_condition_rules(f"{data_path}/EXAM_CONDITION_RULES.csv")

    def validate_reservation(self, reservation: Reservation,
                             patient: Patient,
                             existing_reservations: List[Reservation]) -> ValidationReport:
        """
        단일 예약 검증

        Returns:
            ValidationReport: 검증 결과 (통과/실패, 위반 규칙 목록, 필요 조치)
        """
        report = ValidationReport()

        # 1. 검사 기본 규칙 검증
        exam = self.exam_master[reservation.exam_cd]
        report.add(self._check_basic_rules(exam, reservation, patient))

        # 2. 시간 규칙 검증
        report.add(self._check_time_rules(exam, reservation))

        # 3. 조건 규칙 검증
        report.add(self._check_condition_rules(reservation, patient))

        # 4. 관계 규칙 검증 (기존 예약들과)
        for existing in existing_reservations:
            report.add(self._check_relation_rules(reservation, existing))

        return report

    def validate_all_reservations(self, reservations: List[Reservation],
                                   patients: Dict[str, Patient]) -> BatchValidationReport:
        """전체 예약 일괄 검증"""
        report = BatchValidationReport()

        # 환자별로 그룹핑
        by_patient = group_by_patient(reservations)

        for patient_id, patient_reservations in by_patient.items():
            patient = patients[patient_id]

            for i, reservation in enumerate(patient_reservations):
                other_reservations = patient_reservations[:i] + patient_reservations[i+1:]
                result = self.validate_reservation(reservation, patient, other_reservations)
                report.add(reservation.id, result)

        return report
```

### 4.2 ValidationReport (검증 결과)

```python
@dataclass
class ValidationResult:
    """단일 규칙 검증 결과"""
    is_valid: bool
    message: str
    rule_id: str = None
    severity: str = 'ERROR'  # ERROR, WARNING, INFO

@dataclass
class ValidationReport:
    """예약 검증 리포트"""
    results: List[ValidationResult] = field(default_factory=list)
    required_actions: List[str] = field(default_factory=list)

    @property
    def is_valid(self) -> bool:
        return all(r.is_valid for r in self.results if r.severity == 'ERROR')

    @property
    def errors(self) -> List[ValidationResult]:
        return [r for r in self.results if not r.is_valid and r.severity == 'ERROR']

    @property
    def warnings(self) -> List[ValidationResult]:
        return [r for r in self.results if not r.is_valid and r.severity == 'WARNING']
```

---

## 5. 개발 단계

### Phase 1: 기반 구축
- [x] 프로젝트 구조 생성
- [x] 데이터 모델 정의 (Exam, Patient, Reservation)
- [x] CSV 로더 구현
- [x] 기본 유틸리티 (시간 계산, 간격 계산)

### Phase 2: 규칙 클래스 구현
> **참고**: 규칙 데이터가 이미 정형화되어 있어 복잡한 파싱이 불필요함.
> CSV의 COND_TYPE, COND_OP, ACTION_CD 등이 코드화되어 있으므로,
> 값(VAL) 파싱만 수행하면 됨 (예: `14:00~15:00` → 시간 범위, `11M` → 간격)

- [ ] RelationRule 클래스 (Dict → 클래스 변환 + 검증 로직)
- [ ] ConditionRule 클래스 (Dict → 클래스 변환 + 조건 평가 로직)
- [ ] TimeRule 클래스 (EXAM_MASTER 기반 시간 검증)
- [ ] 값 파싱 유틸리티 (시간 범위, 간격 단위 등)

### Phase 3: 통합 및 검증
- [ ] RuleEngine 메인 클래스 통합
- [ ] ValidationReport 결과 클래스
- [ ] 기존 RESERVATION 데이터로 검증 테스트
- [ ] 위반 사례 리포트 생성

### Phase 4: 고도화
- [ ] 성능 최적화 (규칙 인덱싱)
- [ ] 규칙 충돌 감지
- [ ] 웹 API 연동 (선택)

---

## 6. 사용 예시

### 6.1 단일 예약 검증

```python
from rule_engine import RuleEngine

# 엔진 초기화
engine = RuleEngine()
engine.load_rules('data/')

# 환자 정보
patient = Patient(
    id='P000001',
    age=15,
    medications=['Metformin'],
    allergies=['contrast'],
    is_pregnant=False
)

# 새 예약
new_reservation = Reservation(
    exam_cd='RC060003',  # Abdomen CT (CE)
    reservation_datetime='2026-01-15 14:30:00'
)

# 기존 예약
existing = [
    Reservation(exam_cd='RX010001', reservation_datetime='2026-01-15 10:00:00')
]

# 검증 실행
result = engine.validate_reservation(new_reservation, patient, existing)

print(f"검증 결과: {'통과' if result.is_valid else '실패'}")
print(f"에러: {len(result.errors)}건")
print(f"경고: {len(result.warnings)}건")

for error in result.errors:
    print(f"  - {error.message}")

# 출력 예시:
# 검증 결과: 실패
# 에러: 2건
# 경고: 1건
#   - [R001] 19세 미만 환자: 보호자 동반 필수
#   - [R006] Metformin 복용 중: CT 전후 2일 중단 필요
```

### 6.2 전체 예약 일괄 검증

```python
# 전체 예약 로드
reservations = load_reservations('data/RESERVATION.csv')
patients = load_patients('data/PATIENT.csv')

# 일괄 검증
batch_report = engine.validate_all_reservations(reservations, patients)

# 리포트 출력
print(f"총 예약: {batch_report.total_count}건")
print(f"통과: {batch_report.valid_count}건")
print(f"위반: {batch_report.invalid_count}건")
print(f"위반율: {batch_report.invalid_rate:.1f}%")

# 위반 유형별 통계
for rule_id, count in batch_report.violations_by_rule.items():
    print(f"  {rule_id}: {count}건")
```

---

## 7. 기대 효과

| 항목 | 기대 효과 |
|------|-----------|
| **자동화** | 수동 검증 → 자동 검증 (100% 커버리지) |
| **일관성** | 모든 예약에 동일 규칙 적용 |
| **확장성** | CSV만 수정하면 새 규칙 즉시 적용 |
| **투명성** | 위반 사유 명확하게 기록/추적 |
| **안전성** | 의료 사고 예방 (간격 규칙, 금기 사항) |

---

## 8. 참고 자료

- [EXAM_MASTER.csv](../data/EXAM_MASTER.csv) - 265개 검사 정의
- [EXAM_RELATION_RULES.csv](../data/EXAM_RELATION_RULES.csv) - 87개 관계 규칙
- [EXAM_CONDITION_RULES.csv](../data/EXAM_CONDITION_RULES.csv) - 48개 조건 규칙
- [스키마 설계 문서](./2_스키마_설계.md)
