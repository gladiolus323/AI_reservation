# 검사규칙 스키마 설계 (계획서)

**작성일**: 2025-12-24
**문서 유형**: 설계 계획서

> **참고**: 본 문서는 **설계 계획서**입니다.
> 실제 구현 결과는 [3_스키마_구현_결과.md](3_스키마_구현_결과.md)를 참조하세요.

---

## 1. 개요

본 문서는 병원 검사 예약 규칙을 정형화한 데이터베이스 스키마의 **설계 계획**을 기술합니다.

### 1.1 입력 자료

| 항목 | 내용 |
|------|------|
| 파일 | 통합 검사예약업무 매뉴얼.pdf |
| 분량 | 38페이지 |
| 내용 | CT, MRI, PET, 핵의학, 내시경, 초음파 등 검사 예약 규칙 |

### 1.2 설계 원칙

1. **범용성**: 다른 병원에서도 사용 가능한 스키마
2. **확장성**: 새로운 규칙 유형 추가 용이
3. **명확성**: 코드값과 해석 규칙 명시

---

## 2. 테이블 구조

### 2.1 EXAM_MASTER (검사 기본 정보)

| 컬럼명 | 타입 | 필수 | 설명 |
|--------|------|------|------|
| EXAM_CD | VARCHAR(20) | Y | 검사코드 (PK) |
| EXAM_NM | VARCHAR(200) | Y | 검사명 |
| DURATION_MIN | INT | Y | 소요시간(분) |
| PREP_MIN | INT | N | 사전준비시간(분) |
| WALK_IN_POLICY | CHAR(1) | N | 예약없이 방문 시 (A/C/R) |
| RESULT_DAYS | INT | N | 결과 소요일 |
| FASTING_HRS | INT | N | 금식시간 |
| CONTRAST_YN | CHAR(1) | N | 조영제 사용 (Y/N) |
| SEDATION_YN | CHAR(1) | N | 진정검사 (Y/N) |
| MIN_AGE | DECIMAL(5,2) | N | 최소연령 |
| MAX_AGE | DECIMAL(5,2) | N | 최대연령 |
| AVAIL_START_TIME | TIME | N | 검사 가능 시작 시간 |
| AVAIL_END_TIME | TIME | N | 검사 가능 종료 시간 |
| EQUIPMENT_TYPE | VARCHAR(10) | N | 장비 유형 |

**WALK_IN_POLICY 코드**:
| 코드 | 의미 |
|------|------|
| A | 즉시허용 (Allow) |
| C | 통화후허용 (Call) |
| R | 예약필수 (Reservation) |

**EQUIPMENT_TYPE 분포**:
| 유형 | 검사 수 |
|------|--------|
| CT | 67개 |
| MRI | 65개 |
| FUNC | 76개 |
| US | 29개 |
| NM | 11개 |
| ENDO | 9개 |
| FLUORO | 4개 |
| XRAY | 3개 |

### 2.2 EXAM_RELATION_RULES (검사 간 관계)

| 컬럼명 | 타입 | 필수 | 설명 |
|--------|------|------|------|
| EXAM_A | VARCHAR(20) | Y | 선행 검사코드 |
| EXAM_B | VARCHAR(20) | Y | 후행 검사코드 |
| SEQ_REQ_YN | CHAR(1) | Y | 순서 필수 (Y/N) |
| SAME_DAY_CD | CHAR(1) | Y | 당일시행 (Y/N/C) |
| GAP_VALUE | INT | N | 간격 수치 |
| GAP_UNIT | CHAR(1) | N | 간격 단위 (D/H/M) |
| REV_GAP_VALUE | INT | N | 역방향 간격 수치 |
| REV_GAP_UNIT | CHAR(1) | N | 역방향 간격 단위 |
| REASON_CD | VARCHAR(20) | N | 제한 사유 코드 |

**SAME_DAY_CD 코드**:
| 코드 | 의미 | 설명 |
|------|------|------|
| Y | Yes | 당일 시행 가능 |
| N | No | 당일 시행 불가 (GAP_VALUE=NULL이면 기본 1일 간격) |
| C | Conditional | 조건부 가능 |

**GAP_UNIT 코드**:
| 코드 | 의미 |
|------|------|
| D | Day (일) |
| H | Hour (시간) |
| M | Minute (분) |

**REASON_CD 코드**:
| 코드 | 의미 |
|------|------|
| CONTRAST | 조영제 관련 |
| FASTING | 금식 관련 |
| BOWEL | 장정결 관련 |
| SEDATION | 진정 관련 |
| RADIATION | 방사선 관련 |

### 2.3 EXAM_CONDITION_RULES (조건부 규칙)

| 컬럼명 | 타입 | 필수 | 설명 |
|--------|------|------|------|
| RULE_ID | VARCHAR(10) | Y | 규칙ID |
| EXAM_CD | VARCHAR(20) | Y | 검사코드 |
| COND_TYPE | VARCHAR(20) | Y | 조건유형 |
| COND_OP | VARCHAR(10) | Y | 연산자 |
| COND_VAL | VARCHAR(100) | Y | 조건값 |
| ACTION_CD | VARCHAR(20) | Y | 조치코드 |
| ACTION_VAL | VARCHAR(200) | N | 조치상세 |

**COND_TYPE 코드**:
| 코드 | 의미 |
|------|------|
| AGE | 연령 |
| WEEKDAY | 요일 |
| MED | 복용 약물 |
| ALLERGY | 알레르기 |
| PREG | 임신 여부 |
| DEVICE | 체내 장치 |
| DISEASE | 질환 |
| INTERVAL | 검사 간격 |

**COND_OP 코드**:
| 코드 | 의미 |
|------|------|
| = | 같음 |
| < | 미만 |
| <= | 이하 |
| > | 초과 |
| >= | 이상 |
| != | 같지 않음 |
| IN | 포함 |
| STOP | 중단 필요 |

**ACTION_CD 코드**:
| 코드 | 의미 |
|------|------|
| GUARD | 보호자 동반 필수 |
| NOWEEKEND | 주말 불가 |
| TIMEONLY | 특정 시간만 가능 |
| FASTING | 금식 필요 |
| CONSENT | 동의 필요 |
| PRETEST | 사전검사 필요 |
| STOPMED | 복약 중단 필요 |

---

## 3. 매뉴얼 규칙 정형화 분석

### 3.1 정형화 현황 요약

| 분류 | 건수 | 비율 |
|------|------|------|
| 정형화 완료 | 99개 | 75.6% |
| 로직 구현 필요 | 15개 | 11.5% |
| 정형화 불필요 | 17개 | 13.0% |
| **합계** | **131개** | **100%** |

### 3.2 EXAM_MASTER로 정형화한 규칙 (21개)

| No | 규칙 내용 | 적용 컬럼 | 예시 |
|----|----------|-----------|------|
| 1 | PET 검사 소요시간 2시간 | DURATION_MIN | 120 |
| 2 | MRI 검사 소요시간 40~50분 | DURATION_MIN | 40~50 |
| 3 | Heart MR 검사 소요시간 2시간 | DURATION_MIN | 120 |
| 4 | 진정검사 60분 전 내원 필수 | PREP_MIN | 60 |
| 5 | CT/MAMMO/BMD 당일예약 가능 | WALK_IN_POLICY | A |
| 6 | 초음파/심초음파 당일결과 | RESULT_DAYS | 0 |
| 7 | MRI 8시간 금식 | FASTING_HRS | 8 |
| 8 | CT 조영제 사용 여부 | CONTRAST_YN | Y/N |
| 9 | PSG 21:00~06:00 운영 | AVAIL_START/END_TIME | 21:00~06:00 |

### 3.3 EXAM_RELATION_RULES로 정형화한 규칙 (50개)

| No | EXAM_A | EXAM_B | SAME_DAY | GAP | 순서 | 사유 |
|----|--------|--------|----------|-----|------|------|
| 1 | CT(조영제) | BMD | N | 3D | - | CONTRAST |
| 2 | 위내시경 | 대장내시경 | Y | - | - | - |
| 3 | 대장내시경 | CT | C | 60M | Y | SEDATION |
| 4 | MRI(조영) | MRI(조영) | N | 24H | - | CONTRAST |
| 5 | MRI | PET | N | 1D | - | - |
| 6 | CT(조영)+메포민 | PET | N | 3D | - | CONTRAST |
| 7 | Heart CT | Heart MR | Y | - | Y | FASTING |
| 8 | 투시 | CT | N | 7D | - | CONTRAST |
| 9 | CT | 투시 | N | 2D | - | CONTRAST |
| 10 | 유방MRI | 유방초음파 | C | 2D | - | - |

### 3.4 EXAM_CONDITION_RULES로 정형화한 규칙 (28개)

| No | 대상검사 | 조건 | 조치 |
|----|---------|------|------|
| 1 | CT/MRI(조영제) | AGE < 19 | GUARD (보호자동반) |
| 2 | CT(소아) | AGE <= 15 | TIMEONLY (14:00~15:00) |
| 3 | 진정 MRI/CT | WEEKDAY = 토/일 | NOWEEKEND |
| 4 | CT(조영제) | MED = 메포민 | STOPMED (전후 2일) |
| 5 | 내시경 | MED = 아스피린 | STOPMED (5~7일) |
| 6 | MRI | PREG = Y | 조영제 미사용 |
| 7 | MRI | DEVICE = 심박동기 | TIMEONLY (평일 근무시간) |
| 8 | PET | DISEASE = 당뇨 | TIMEONLY (오전) |

---

## 4. 로직 구현 필요 규칙 (15개)

테이블로 정형화 불가능하여 프로그램 코드로 구현해야 하는 규칙입니다.

### 4.1 시간 기반 동적 계산 (5개)

| 규칙 | 필요 로직 |
|------|----------|
| 위내시경 오후 시 8시간 금식 계산 | 검사시간 기준 역산 |
| Coronary CT 후 1시간30분 뒤 다음검사 | 맥박조절 대기시간 계산 |
| Holter 기계 제거일 계산 | 부착일+일수 (주말 고려) |
| 72시간 Holter 결과 15일 후 | 기계 부착일 기준 |
| 진료시간 기준 검사예약 시간 계산 | RTC 시간 기반 역산 |

### 4.2 캘린더/스케줄 조회 (3개)

| 규칙 | 필요 로직 |
|------|----------|
| RTC 일주일 전 예약 (공휴일 제외) | 공휴일 마스터 + 영업일 계산 |
| MSLT 수면다원 다음날 8:30 예약 | 토/공휴일 제외 검증 |
| 핵의학 검사 3시반~4시반 이후 예약 불가 | 약물 준비 시간 체크 |

### 4.3 복합 조건 처리 (4개)

| 규칙 | 필요 로직 |
|------|----------|
| 복합 처방 시 최대 금식시간 적용 | 여러 검사 MAX 연산 |
| 같은 날 CT 여러개 시 contrast 1개만 과금 | 처방 순회 + 과금 로직 |
| CT entero + 대장내시경 약 설명 분기 | 검사조합별 분기 |
| BMD 11개월 이내 비급여 전환 | 마지막 검사일 조회 |

### 4.4 텍스트 파싱 (3개)

| 규칙 | 필요 로직 |
|------|----------|
| CT 장정결제(쿨프렙) 처방 확인 | Remark 키워드 파싱 |
| 내시경 직접 메모 시 교수방 자동 배정 | Remark + 스케줄 매칭 |
| 슬롯 부족 시 검사실 통화 필요 알림 | 실시간 슬롯 조회 |

---

## 5. 정형화 불필요 규칙 (17개)

### 5.1 임시 스케줄/공지 (10개)

- 7번방 금토 내시경 X (5/20 공지)
- IMG 이주엽샘 12/23~2/14 휴직
- 유방초음파 12/20일 이후 예약하지 말기
- 이진욱 교수님 25년3월~26년2월 해외연수
- 위내시경 토요일 오전 가능 (8월말까지 안함)
- 등

### 5.2 운영 지침 (7개)

- 황재석 교수님 출장 많아서 넉넉하게 잡아준다
- 검사실에서 급한 환자는 통화하고 예약
- 병동오더로는 예약 할 수 없다
- 환자 검사예약 중 특이사항 메모 기재
- 등

---

## 6. 추가 정의 검사코드 (14개)

매뉴얼에는 있지만 기존 데이터(constraints.csv)에 없던 검사:

| 코드 | 검사명 | 장비 | 추가 사유 |
|------|--------|------|----------|
| RX010001 | BMD (골밀도검사) | DEXA | CT→BMD 3일 간격 |
| RX020001 | Mammography | - | 핵의학 순서 규칙 |
| RX030001 | EOS (전척추촬영) | EOS | Bone scan 순서 |
| RF020001 | Defecogram | FLUORO | 대장내시경 간격 |
| RF030001 | Esophagography | FLUORO | CT 간격 |
| RF040001 | VCUG | FLUORO | Renal Scan 간격 |
| SC040001 | UBT | - | 내시경 순서 |
| SC050001 | Esophageal Manometry | - | 위내시경 간격 |
| SC050002 | Anorectal Manometry | - | 대장내시경 간격 |
| SC060001 | CPX | - | Heart MR 관계 |
| SC070001 | PSG (수면다원검사) | FUNC | 야간 검사 |
| SC070002 | MSLT (주간졸림검사) | FUNC | PSG 연계 |
| RM060001 | Breast MRI | MRI | 유방 초음파 간격 |
| RU060001 | Breast Sono | US | 유방 MRI 간격 |

---

## 7. 데이터 정합성 검증 결과

### 7.1 테이블별 검증

| 테이블 | 건수 | 오류 | 경고 | 판정 |
|--------|------|------|------|------|
| EXAM_MASTER | 265 | 0 | 0 | PASS |
| EXAM_RELATION_RULES | 88 | 0 | 20 | PASS |
| EXAM_CONDITION_RULES | 47 | 0 | 0 | PASS |

### 7.2 경고 사항

**SAME_DAY_CD=N인데 GAP_VALUE 없음 (20건)**:
- 해석 규칙: "당일 불가 + GAP_VALUE=NULL → 기본 1일 간격"
- code_definition.csv에 명시됨

### 7.3 외래키 검증

| 검증 항목 | 결과 |
|-----------|------|
| EXAM_A → EXAM_MASTER | 100% 통과 |
| EXAM_B → EXAM_MASTER | 100% 통과 |
| EXAM_CD → EXAM_MASTER | 100% 통과 |

### 7.4 코드값 유효성

| 컬럼 | 허용값 | 결과 |
|------|--------|------|
| SEQ_REQ_YN | Y, N | 통과 |
| SAME_DAY_CD | Y, N, C | 통과 |
| GAP_UNIT | M, H, D | 통과 |
| COND_OP | <, <=, >, >=, =, !=, IN, STOP | 통과 |

---

## 8. 시간 제한 규칙 이원화

검사 시간 제한은 두 가지 방식으로 관리:

| 구분 | 테이블 | 용도 | 예시 |
|------|--------|------|------|
| 검사 자체 시간 | EXAM_MASTER | 검사실 운영 시간 | PSG 21:00~06:00 |
| 조건부 시간 | EXAM_CONDITION_RULES | 환자 조건별 | 소아 CT 14:00~15:00 |

**해석 규칙**:
1. EXAM_MASTER의 AVAIL_START/END_TIME → 해당 시간대에만 예약 가능
2. CONDITION_RULES의 TIMEONLY → 해당 시간대로 추가 제한
3. 두 조건 모두 있으면 → 교집합 시간대만 가능

---

## 9. 발견된 이슈 및 해결

### 9.1 충돌 규칙

**문제**: 대장내시경↔CT 규칙에서 상반된 순서

| 라인 | 규칙 | 의미 |
|------|------|------|
| 8 | SC030010→RC060003, SEQ=Y | 내시경 먼저 |
| (삭제) | RC060003→SC030010, SEQ=Y | CT 먼저 |

**해결**: 임상적으로 올바른 규칙(내시경 먼저, 진정 관련) 유지

### 9.2 역방향 간격

일부 규칙은 A→B와 B→A 간격이 다름:
- CT → 투시: 2일
- 투시 → CT: 7일

**해결**: REV_GAP_VALUE/REV_GAP_UNIT 컬럼으로 표현

---

## 10. 권장 추가 테이블

현재 스키마 외에 향후 필요할 수 있는 테이블:

| 테이블명 | 용도 |
|---------|------|
| PROFESSOR_SCHEDULE | 교수별 검사 스케줄 |
| ROOM_SCHEDULE | 검사실별 운영 시간 |
| HOLIDAY_MASTER | 공휴일 마스터 (영업일 계산용) |
| EXAM_COMBINATION | 검사조합별 안내문 |

---

*최종 업데이트: 2025-12-24*
