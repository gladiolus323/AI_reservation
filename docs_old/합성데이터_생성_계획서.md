# 검사 예약 시뮬레이션용 합성 데이터 생성 계획서

---

## 1. 목적

환자에게 2-5개의 검사를 처방할 때, **검사 간 규칙을 위반하지 않으면서** 예약 가능한 날짜를 추천하는 프로그램을 개발하기 위한 합성 데이터를 생성한다.

### 1.1 최종 목표
- 입력: 환자 ID + 검사 코드 2-5개
- 출력: 모든 규칙을 만족하는 예약 가능 날짜 조합

### 1.2 필요한 검증

**핵심: data 폴더의 검사 규칙을 모두 준수하는지 검증**

| 규칙 테이블 | 검증 내용 | 건수 |
|------------|----------|------|
| EXAM_RELATION_RULES | 검사 간 관계 규칙 준수 | 88건 |
| EXAM_CONDITION_RULES | 환자 조건별 규칙 준수 | 47건 |
| EXAM_MASTER | 소요시간(DURATION_MIN) 적용 | 265건 |

**EXAM_RELATION_RULES 검증 항목**:
- SAME_DAY_CD=Y: 같은 날 배치되는지
- SAME_DAY_CD=N + GAP_VALUE: 지정된 간격 이상 유지되는지
- SAME_DAY_CD=C: 같은 날 또는 지정 간격 중 하나 만족하는지
- SEQ_REQ_YN=Y: 검사 순서가 지켜지는지

**EXAM_CONDITION_RULES 검증 항목**:
- AGE 조건: 연령 제한 검사가 올바르게 제한되는지
- MED 조건: 약물 중단 규칙이 적용되는지
- ALLERGY/DISEASE 조건: 환자 상태에 따른 제약 적용

**추가 검증**:
- 리소스(장비) 슬롯 충돌 없음
- 운영시간(09:00-17:00) 내 배치

---

## 2. 원본 데이터 분석

### 2.1 source.xlsx 구조

source.xlsx는 실제 병원 예약 데이터로, 다음 정보를 포함:
- 환자별 처방 내역 (처방ID, 환자번호, 검사코드, 검사명)
- 예약 일시 정보
- 부서 정보

### 2.2 기존 pre_synthetic_data의 문제점

| 파일 | 문제점 |
|------|--------|
| patient_schedule.csv | constraints.csv 기준 소요시간 사용 |
| resource_schedule.csv | 소요시간이 EXAM_MASTER와 다름 (예: PET 60분→120분) |
| constraints.csv | 매뉴얼과 다른 소요시간 다수 존재 |

**결론**: 기존 파일을 재사용하면 슬롯 충돌 발생 → **처음부터 새로 생성**

### 2.3 소요시간 기준

| 구분 | 소요시간 기준 | 사용 여부 |
|------|-------------|----------|
| constraints.csv | 기존 시스템 값 (부정확) | ❌ 사용 안함 |
| **EXAM_MASTER.csv** | **매뉴얼 기준 (정확)** | **✅ 사용** |

---

## 3. 데이터 구조 설계

### 3.1 기존 데이터 (data 폴더) - 규칙 정의

| 파일 | 역할 | 건수 |
|------|------|------|
| EXAM_MASTER.csv | 검사 마스터 (소요시간, 장비 등) | 265건 |
| EXAM_RELATION_RULES.csv | 검사 간 관계 규칙 | 88건 |
| EXAM_CONDITION_RULES.csv | 조건부 규칙 | 47건 |

### 3.2 신규 생성 데이터 (synthetic_data 폴더) - 시뮬레이션용

| 파일 | 역할 | 생성 방식 |
|------|------|----------|
| RESOURCE_MASTER.csv | 리소스(장비/검사실) 마스터 | source.xlsx에서 추출 |
| RESOURCE_SCHEDULE.csv | 리소스별 기존 예약 현황 | source.xlsx + EXAM_MASTER로 신규 생성 |
| PATIENT_ORDER.csv | 환자별 검사 처방 목록 | source.xlsx에서 추출 |
| TEST_SCENARIOS.csv | 테스트 시나리오 | 규칙 검증용 수동 설계 |

---

## 4. 각 파일 상세 설계

### 4.1 RESOURCE_MASTER.csv

**목적**: 병원 내 검사 장비/검사실 목록

| 컬럼 | 타입 | 설명 | 예시 |
|------|------|------|------|
| RESOURCE_ID | VARCHAR | 리소스 고유 ID | R001 |
| RESOURCE_NM | VARCHAR | 리소스명 | CT_1 |
| EQUIPMENT_TYPE | VARCHAR | 장비 유형 | CT |
| OPEN_TIME | TIME | 운영 시작 시간 | 09:00 |
| CLOSE_TIME | TIME | 운영 종료 시간 | 17:00 |
| SLOT_UNIT_MIN | INT | 슬롯 단위 (분) | 10 |

**생성 방법**:
```
1. source.xlsx에서 장비 유형 목록 추출
2. EXAM_MASTER의 장비 유형과 매핑
3. 각 장비 유형별 1개 이상의 리소스 생성
4. 운영시간은 09:00-17:00 기본값 적용
5. 슬롯 단위는 10분 기본값 적용
```

**예상 데이터**:
```
RESOURCE_ID,RESOURCE_NM,EQUIPMENT_TYPE,OPEN_TIME,CLOSE_TIME,SLOT_UNIT_MIN
R001,CT_1,CT,09:00,17:00,10
R002,CT_2,CT,09:00,17:00,10
R003,MRI_1,MRI,09:00,17:00,10
R004,MRI_2,MRI,09:00,17:00,10
R005,초음파_1,Ultrasound,09:00,17:00,10
R006,PET-CT_1,PET-CT,09:00,17:00,10
R007,내시경실_1,내시경실,09:00,17:00,10
...
```

---

### 4.2 RESOURCE_SCHEDULE.csv

**목적**: 리소스별 기존 예약 현황 (가용성 확인용)

| 컬럼 | 타입 | 설명 | 예시 |
|------|------|------|------|
| SCHEDULE_ID | VARCHAR | 스케줄 고유 ID | SCH_0001 |
| RESOURCE_ID | VARCHAR | 리소스 ID | R001 |
| DATE | DATE | 예약 날짜 | 2026-01-12 |
| START_TIME | TIME | 시작 시간 | 10:30 |
| END_TIME | TIME | 종료 시간 | 11:00 |
| ORDER_ID | VARCHAR | 연결된 처방 ID | ORD_0001 |
| PATIENT_ID | VARCHAR | 환자 번호 | P0001 |
| EXAM_CD | VARCHAR | 검사 코드 | RC080004 |

**생성 방법 (핵심 - 처음부터 새로 생성)**:
```
1. source.xlsx에서 예약 목록 추출
2. 각 검사코드 → EXAM_MASTER.DURATION_MIN 조회하여 소요시간 결정
3. 리소스별로 예약을 시간순 정렬
4. 슬롯 충돌 방지를 위해 순차 배치:
   - 같은 리소스에서 이전 예약 종료시간 이후에 다음 예약 시작
   - 운영시간(09:00-17:00) 내에서만 배치
   - 하루에 배치 불가 시 다음 날로 이동
5. 종료시간 = 시작시간 + DURATION_MIN
```

**슬롯 배치 알고리즘**:
```
for each 날짜:
    for each 리소스:
        current_time = OPEN_TIME (09:00)
        for each 해당리소스_예약 (시간순):
            if current_time + duration <= CLOSE_TIME:
                예약.시작시간 = current_time
                예약.종료시간 = current_time + duration
                current_time = 예약.종료시간
            else:
                # 다음 날로 이동
                다음날에_재배치()
```

**주의사항**:
- 반드시 EXAM_MASTER.DURATION_MIN 사용 (constraints.csv 아님)
- 슬롯 충돌이 절대 발생하지 않도록 순차 배치
- 소요시간이 긴 검사(PET 120분, MRI 45분 등) 고려

---

### 4.3 PATIENT_ORDER.csv

**목적**: 환자별 처방된 검사 목록

| 컬럼 | 타입 | 설명 | 예시 |
|------|------|------|------|
| ORDER_ID | VARCHAR | 처방 ID | ORD_0001 |
| PATIENT_ID | VARCHAR | 환자 번호 | P0001 |
| EXAM_CD | VARCHAR | 검사 코드 | RC080004 |
| EXAM_NM | VARCHAR | 검사명 | C-spine 3D CT |
| ORDER_DEPT | VARCHAR | 처방 부서 | NS |
| ORDER_DATE | DATE | 처방일 | 2026-01-10 |
| STATUS | VARCHAR | 상태 | SCHEDULED / PENDING |
| SCHEDULED_DATE | DATE | 예약일 (있으면) | 2026-01-12 |
| SCHEDULED_TIME | TIME | 예약시간 (있으면) | 10:30 |

**생성 방법**:
```
1. source.xlsx에서 환자별 처방 목록 추출
2. 처방일 = 예약일 - 7일 (가정)
3. RESOURCE_SCHEDULE과 연동하여 예약 정보 매핑
4. 기존 예약된 건: STATUS = SCHEDULED
5. 테스트용 미예약 건 추가: STATUS = PENDING (신규 생성)
```

**환자 ID 생성 규칙**:
```
- 기존 환자: P0001 ~ P9999 (source.xlsx 기반)
- 테스트 환자: TEST_P001 ~ TEST_P021 (테스트 시나리오용)
```

---

### 4.4 TEST_SCENARIOS.csv

**목적**: 규칙 검증을 위한 테스트 시나리오

| 컬럼 | 타입 | 설명 | 예시 |
|------|------|------|------|
| SCENARIO_ID | VARCHAR | 시나리오 ID | TS_001 |
| SCENARIO_NM | VARCHAR | 시나리오명 | 같은날_필수_2건 |
| PATIENT_ID | VARCHAR | 테스트 환자 ID | TEST_P001 |
| EXAM_LIST | VARCHAR | 검사 코드 목록 (콤마 구분) | SC030005,SC030010 |
| EXPECTED_RESULT | VARCHAR | 예상 결과 | SAME_DAY |
| RULE_TESTED | VARCHAR | 테스트하는 규칙 | SAME_DAY_CD=Y |
| DESCRIPTION | VARCHAR | 설명 | 위/대장내시경 같은날 검사 |

---

## 5. 테스트 시나리오 설계

### 5.1 시나리오 분류

| 분류 | 검사 수 | 케이스 수 | 설명 |
|------|---------|----------|------|
| A. 같은 날 필수 | 2-3개 | 5개 | SAME_DAY_CD=Y 검증 |
| B. 간격 필요 | 2개 | 5개 | GAP_VALUE 검증 |
| C. 순서 필요 | 2개 | 3개 | SEQ_REQ_YN=Y 검증 |
| D. 복합 케이스 | 3-5개 | 5개 | 여러 규칙 조합 |
| E. 리소스 충돌 | 2-3개 | 3개 | 같은 장비 시간 겹침 |
| **합계** | - | **21개** | - |

### 5.2 상세 시나리오

#### A. 같은 날 필수 (SAME_DAY_CD=Y)

| ID | 검사 목록 | 규칙 | 예상 결과 |
|----|----------|------|----------|
| TS_A01 | SC030005, SC030010 | 위내시경→대장내시경 같은날 | 두 검사 같은 날 배치 |
| TS_A02 | SC030006, SC030009 | EGD+FB→Colon+FB 같은날 | 두 검사 같은 날 배치 |
| TS_A03 | RM050031, NM020003 | MRI→PET 같은날 | 두 검사 같은 날 배치 |
| TS_A04 | RC050002, RM010029 | Cardiac CT→Heart MRI 같은날+금식 | 같은 날 + 금식 조건 |
| TS_A05 | SC140005, SC140006, SC140008 | 청력검사 세트 | 3개 같은 날 연속 배치 |

#### B. 간격 필요 (GAP_VALUE)

| ID | 검사 목록 | 규칙 | 예상 결과 |
|----|----------|------|----------|
| TS_B01 | RC060003, RX010001 | Abdomen CT → BMD 3일 간격 | 3일 이상 간격 |
| TS_B02 | RC060003, NM020003 | Abdomen CT → PET 1일 간격 | 1일 이상 간격 |
| TS_B03 | RM050059, RM050059 | 조영 MRI 반복 24시간 간격 | 24시간 이상 간격 |
| TS_B04 | RM060001, RU060001 | 유방 MRI → 유방 초음파 2일 | 같은날 OK 또는 2일 간격 |
| TS_B05 | RF040001, NM010011 | VCUG → Kidney Scan 2일 | 2일 이상 간격 |

#### C. 순서 필요 (SEQ_REQ_YN=Y)

| ID | 검사 목록 | 규칙 | 예상 결과 |
|----|----------|------|----------|
| TS_C01 | SC030010, RC060003 | 대장내시경 → Abdomen CT | 순서 유지 + 60분 간격 |
| TS_C02 | RM050031, RM050059 | MRI Base → MRI Special | 순서 유지 |
| TS_C03 | RC050002, RM010029 | Cardiac CT → Heart MRI | 순서 유지 |

#### D. 복합 케이스

| ID | 검사 목록 | 규칙 조합 | 예상 결과 |
|----|----------|----------|----------|
| TS_D01 | SC030005, SC030010, RC060003 | 내시경 같은날 + CT 순서 | Day1: 내시경2개, Day1+60분: CT |
| TS_D02 | RC060003, RX010001, NM020003 | CT→BMD 3일, CT→PET 1일 | 복잡한 간격 조합 |
| TS_D03 | RM050031, NM020003, RC060003 | MRI+PET 같은날 + CT 다른날 | 2그룹 분리 |
| TS_D04 | SC140005, SC140006, SC140008, SC140010 | 청력검사 4개 세트 | 모두 같은 날 연속 |
| TS_D05 | RC050002, RM010029, NM020003, RX010001 | 4개 복합 | 다중 규칙 조합 |

#### E. 리소스 충돌 테스트

| ID | 검사 목록 | 상황 | 예상 결과 |
|----|----------|------|----------|
| TS_E01 | RC010001, RC060003 | CT 2개 같은 시간 | 시간 분리 배치 |
| TS_E02 | RM080020, RM070001 | MRI 2개 연속 | 연속 슬롯 배치 |
| TS_E03 | SC030005, SC030010 | 내시경 2개 같은날 | 연속 슬롯 배치 |

---

## 6. 생성 절차

### 6.1 단계별 진행

```
[1단계] source.xlsx 분석
    └─ 시트 구조 파악
    └─ 환자 수, 예약 건수 확인
    └─ 검사코드 목록 추출

[2단계] EXAM_MASTER와 매핑 검증
    └─ source.xlsx의 검사코드가 EXAM_MASTER에 존재하는지 확인
    └─ 누락된 검사코드 목록 정리
    └─ 장비유형(EQUIPMENT_TYPE) 매핑

[3단계] RESOURCE_MASTER.csv 생성
    └─ 장비유형별 리소스 정의
    └─ 리소스 수 결정 (예: CT 2대, MRI 2대 등)
    └─ 운영시간 설정

[4단계] RESOURCE_SCHEDULE.csv 생성 (핵심)
    └─ source.xlsx의 예약을 시간순 정렬
    └─ EXAM_MASTER.DURATION_MIN 기준으로 종료시간 계산
    └─ 슬롯 충돌 없이 순차 배치
    └─ 충돌 발생 시 다음 슬롯/다음 날로 조정

[5단계] PATIENT_ORDER.csv 생성
    └─ source.xlsx에서 환자별 처방 목록 추출
    └─ RESOURCE_SCHEDULE과 연동하여 예약 상태 설정
    └─ 테스트용 미예약 건 추가

[6단계] TEST_SCENARIOS.csv 생성
    └─ 21개 시나리오 정의
    └─ 테스트용 환자 ID 부여 (TEST_P001~TEST_P021)
    └─ 각 시나리오별 예상 결과 명시

[7단계] 검증
    └─ 데이터 정합성 확인
    └─ 슬롯 충돌 0건 확인
    └─ 규칙 커버리지 확인
```

### 6.2 폴더 구조

```
검사규칙 합성데이터/
├── data/                          # 규칙 정의 데이터 (기존)
│   ├── EXAM_MASTER.csv
│   ├── EXAM_RELATION_RULES.csv
│   └── EXAM_CONDITION_RULES.csv
│
├── synthetic_data/                # 시뮬레이션용 합성 데이터 (신규)
│   ├── RESOURCE_MASTER.csv
│   ├── RESOURCE_SCHEDULE.csv
│   ├── PATIENT_ORDER.csv
│   └── TEST_SCENARIOS.csv
│
├── pre_synthetic_data/            # 원본 데이터 (참조용, 더이상 사용 안함)
│   ├── source.xlsx               # 원본 병원 데이터 ← 이것만 사용
│   ├── patient_schedule.csv      # 폐기 (소요시간 불일치)
│   ├── resource_schedule.csv     # 폐기 (슬롯 충돌 문제)
│   └── constraints.csv           # 폐기 (EXAM_MASTER로 대체)
│
└── docs/
    └── 합성데이터_생성_계획서.md   # 본 문서
```

---

## 7. 데이터 간 관계

```
┌─────────────────────────────────────────────────────────────┐
│                    원본 데이터                               │
├─────────────────────────────────────────────────────────────┤
│                    source.xlsx                              │
│                  (실제 병원 예약 데이터)                      │
│                         │                                   │
│         ┌───────────────┼───────────────┐                   │
│         ▼               ▼               ▼                   │
│   환자 정보       예약 정보        검사 정보                 │
└─────────┬───────────────┬───────────────┬───────────────────┘
          │               │               │
          ▼               ▼               ▼
┌─────────────────────────────────────────────────────────────┐
│                    규칙 정의 (data/)                         │
├─────────────────────────────────────────────────────────────┤
│  EXAM_MASTER ─────┬───── EXAM_RELATION_RULES                │
│   (검사정보)       │         (검사간 규칙)                    │
│   - DURATION_MIN  │              │                          │
│   - EQUIPMENT_TYPE│───── EXAM_CONDITION_RULES               │
│                   │        (조건부 규칙)                     │
└───────────────────┼─────────────────────────────────────────┘
                    │
                    │ EXAM_CD, DURATION_MIN, EQUIPMENT_TYPE
                    ▼
┌─────────────────────────────────────────────────────────────┐
│                시뮬레이션 데이터 (synthetic_data/)            │
├─────────────────────────────────────────────────────────────┤
│  RESOURCE_MASTER ◄─────── RESOURCE_SCHEDULE                 │
│   (장비 마스터)            (기존 예약 현황)                   │
│   - EQUIPMENT_TYPE         - 슬롯 충돌 없음 보장             │
│   - 운영시간               - DURATION_MIN 기준 종료시간      │
│         │                        │                          │
│         │                        │ ORDER_ID                 │
│         │                        ▼                          │
│         └──────────────── PATIENT_ORDER                     │
│                           (환자 처방 목록)                   │
│                                  │                          │
│                                  │ 테스트 대상               │
│                                  ▼                          │
│                          TEST_SCENARIOS                     │
│                          (테스트 시나리오)                   │
└─────────────────────────────────────────────────────────────┘
```

---

## 8. 검증 항목

### 8.1 데이터 품질 검증

| 항목 | 검증 내용 | 기준 |
|------|----------|------|
| 참조 무결성 | EXAM_CD가 EXAM_MASTER에 존재 | 100% |
| 시간 정합성 | END_TIME > START_TIME | 100% |
| **슬롯 충돌** | **같은 리소스 시간 겹침 없음** | **0건 (필수)** |
| 소요시간 일치 | END-START = DURATION_MIN | 100% |
| 운영시간 준수 | 09:00 ≤ START_TIME, END_TIME ≤ 17:00 | 100% |

### 8.2 규칙 커버리지 검증

| 규칙 유형 | EXAM_RELATION_RULES 건수 | 테스트 시나리오 |
|----------|-------------------------|----------------|
| SAME_DAY_CD=Y | 약 20건 | TS_A01~A05 |
| SAME_DAY_CD=N + GAP | 약 30건 | TS_B01~B05 |
| SEQ_REQ_YN=Y | 약 15건 | TS_C01~C03 |
| 복합 | 다수 | TS_D01~D05 |

---

## 9. 예상 결과물

| 파일 | 예상 건수 | 비고 |
|------|----------|------|
| RESOURCE_MASTER.csv | 15-25건 | 장비 유형별 1-2개 |
| RESOURCE_SCHEDULE.csv | 500-800건 | source.xlsx 예약 재배치 |
| PATIENT_ORDER.csv | 500-800건 | 환자별 처방 목록 |
| TEST_SCENARIOS.csv | 21건 | 테스트 케이스 |

---

## 10. 주요 변경 사항 (기존 대비)

| 항목 | 기존 방식 | 변경된 방식 |
|------|----------|-----------|
| 소요시간 기준 | constraints.csv | **EXAM_MASTER.DURATION_MIN** |
| 데이터 출처 | resource_schedule.csv 재구성 | **source.xlsx에서 신규 생성** |
| 슬롯 충돌 | 재계산 후 조정 | **처음부터 충돌 없이 배치** |
| 종료시간 | 기존 값 수정 | **시작시간 + DURATION_MIN** |

---

## 11. 다음 단계

1. ✅ 본 계획서 검토 및 승인
2. source.xlsx 분석 (시트 구조, 데이터 건수)
3. EXAM_MASTER와 검사코드 매핑 검증
4. RESOURCE_MASTER.csv 생성
5. RESOURCE_SCHEDULE.csv 생성 (슬롯 충돌 없이)
6. PATIENT_ORDER.csv 생성
7. TEST_SCENARIOS.csv 생성
8. 전체 데이터 검증 및 문서화

---

*작성일: 2025-12-23*
*수정일: 2025-12-23 - 처음부터 새로 생성 방식으로 변경*
