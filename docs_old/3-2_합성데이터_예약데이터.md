# 합성데이터 생성 - 예약 데이터

**최종 수정일**: 2025-12-24

---

## 1. 개요

### 1.1 생성 목적

1. **규칙 검증 테스트**: EXAM_RELATION_RULES, EXAM_CONDITION_RULES 규칙이 실제 예약에서 작동하는지 검증
2. **스케줄링 시뮬레이션**: 장비 자원 충돌 없이 예약이 배정되는지 확인
3. **시스템 개발 지원**: 예약 시스템 개발/테스트를 위한 현실적인 샘플 데이터 제공
4. **룰엔진 개발**: 환자에게 2-5개 검사 처방 시 규칙을 준수하는 예약 가능 날짜 추천 프로그램 개발

### 1.2 생성 규모

| 항목 | 수치 |
|------|------|
| 예약 건수 | 12,063건 |
| 환자 수 | 2,602명 |
| 검사 코드 커버리지 | 264개 (100%) |
| 기간 | 2026-01-01 ~ 2026-12-31 (1년) |
| 자원 (장비) | 36대 |

### 1.3 원본 데이터

| 원본 | 용도 | 비고 |
|------|------|------|
| source.xlsx | 실제 병원 예약 패턴 참조 | pre_synthetic_data/ 폴더 |
| EXAM_MASTER.csv | 소요시간(DURATION_MIN) 적용 | 매뉴얼 기준 정확한 시간 |

**기존 pre_synthetic_data 파일 미사용 사유**:
- constraints.csv: 소요시간이 매뉴얼과 다름 (예: PET 60분→120분)
- resource_schedule.csv: 슬롯 충돌 문제 존재
- **결론**: EXAM_MASTER 기준으로 처음부터 새로 생성

---

## 2. RESERVATION.csv 컬럼 정의

| 컬럼명 | 타입 | 설명 | 예시 |
|--------|------|------|------|
| RESERVATION_ID | VARCHAR(10) | 예약 ID | R00000001 |
| ORDER_ID | VARCHAR(10) | 처방 ID | O00000001 |
| PATIENT_ID | VARCHAR(7) | 환자 ID | P000001 |
| ORDER_DATE | DATE | 처방일 | 2026-01-01 |
| EXAM_CD | VARCHAR(10) | 검사 코드 | RC060003 |
| EXAM_NM | VARCHAR(100) | 검사명 | Abdomen CT (CE) |
| RESERVATION_DATETIME | DATETIME | 예약 일시 | 2026-01-05 10:30 |
| RESERVATION_DATE | DATE | 예약 날짜 | 2026-01-05 |
| RESERVATION_TIME | TIME | 예약 시간 | 10:30 |
| DURATION_MIN | INT | 소요 시간 (분) | 20 |
| EQUIPMENT_TYPE | VARCHAR(10) | 장비 유형 | CT |
| RESOURCE_ID | VARCHAR(10) | 자원 ID | CT_01 |

---

## 3. RESOURCE.csv 컬럼 정의

| 컬럼명 | 타입 | 설명 | 예시 |
|--------|------|------|------|
| RESOURCE_ID | VARCHAR(10) | 자원 ID | CT_01 |
| EQUIPMENT_TYPE | VARCHAR(10) | 장비 유형 | CT |
| RESOURCE_NAME | VARCHAR(50) | 자원명 | CT 1호기 |

### 장비별 자원 대수

| 장비 | 자원 수 | 피크 시점 | 비고 |
|------|---------|----------|------|
| CT | 4대 | 2026-06-17 14:23 | - |
| MRI | 5대 | 2026-07-24 11:22 | - |
| US | 4대 | 2026-01-17 09:36 | 3→4 (충돌 해결) |
| NM | 4대 | 2026-05-22 11:14 | - |
| ENDO | 5대 | 2026-05-14 11:56 | - |
| FUNC | 8대 | 2026-06-30 14:06 | - |
| XRAY | 3대 | 2026-01-21 09:30 | 2→3 (충돌 해결) |
| FLUORO | 3대 | 2026-03-25 12:17 | - |
| **합계** | **36대** | | |

**자원 수량 결정 방법**:
- RESERVATION 데이터에서 시간대별 최대 동시 사용량 추출
- 피크 시점에 동시에 사용되는 장비 수 + 여유분

---

## 4. 생성 전략

### 4.1 검사 코드 선택 (역사용횟수 가중치)

모든 검사 코드(264개)가 최소 1회 이상 사용되도록 보장:

```python
def get_random_exam(equipment_type):
    # 해당 장비의 검사 목록
    exams = exam_master[exam_master['EQUIPMENT_TYPE'] == equipment_type]

    # 역사용횟수 가중치 계산 (덜 사용된 검사 우선)
    weights = 1 / (exam_usage_count + 1)
    weights = weights / weights.sum()

    # 가중치 기반 랜덤 선택
    return np.random.choice(exams['EXAM_CD'], p=weights)
```

### 4.2 소요시간 기준

| 구분 | 소요시간 기준 | 사용 여부 |
|------|-------------|----------|
| constraints.csv | 기존 시스템 값 (부정확) | X 사용 안함 |
| **EXAM_MASTER.csv** | **매뉴얼 기준 (정확)** | **O 사용** |

### 4.3 시간대 배정

| 조건 | 시간대 | 근거 |
|------|--------|------|
| 평일 | 08:00~14:59 | 병원 운영 시간 |
| 토요일 | 08:00~12:59 | 축소 운영 |
| PSG (수면다원검사) | 21:00 고정 | EXAM_MASTER AVAIL_START_TIME |
| MSLT (주간졸림검사) | 08:30 고정 | EXAM_MASTER AVAIL_START_TIME |

### 4.4 규칙 적용 순서

```
[1] NOWEEKEND 필터링
    └─ 토요일 예약 대상 검사 필터링 (EXAM_CONDITION_RULES)

[2] SAME_DAY_CD=N 처리
    └─ 당일 시행 불가 검사쌍 분리 (EXAM_RELATION_RULES)

[3] GAP_VALUE 적용
    └─ 최소 간격 확보 (분/시간/일)

[4] SEQ_REQ_YN=Y 적용
    └─ 순서 필수 검사 정렬 (같은 날 기준)

[5] 자원 충돌 검사
    └─ 동일 자원 시간 중복 방지
```

### 4.5 슬롯 배치 알고리즘

```python
for each 날짜:
    for each 리소스:
        current_time = OPEN_TIME (08:00)
        for each 해당리소스_예약 (시간순):
            if current_time + duration <= CLOSE_TIME:
                예약.시작시간 = current_time
                예약.종료시간 = current_time + duration
                current_time = 예약.종료시간
            else:
                # 다음 날로 이동
                다음날에_재배치()
```

**핵심**: EXAM_MASTER.DURATION_MIN 기준으로 종료시간 계산, 슬롯 충돌 0건 보장

---

## 5. 분포 분석 (EDA)

### 5.1 시간대별 분포

| 시간 | 예약 건수 | 비율 | 비고 |
|------|----------|------|------|
| 08시 | 859건 | 7.1% | 시작 시간대 |
| 09시 | 1,999건 | 16.6% | 피크타임 시작 |
| 10시 | 1,970건 | 16.3% | 피크타임 |
| 11시 | 2,001건 | 16.6% | 피크타임 |
| 12시 | 1,805건 | 15.0% | 점심시간대 |
| 13시 | 1,792건 | 14.9% | 오후 시작 |
| 14시 | 1,415건 | 11.7% | 오후 감소 |
| 15시+ | 193건 | 1.6% | 특수 검사 |
| 21시 | 29건 | 0.2% | PSG 전용 |

**분석**: 오전 9~11시가 피크타임 (49.5%), 실제 병원 패턴 반영

### 5.2 요일별 분포

| 요일 | 예약 건수 | 비율 | 비고 |
|------|----------|------|------|
| Monday | 2,212건 | 18.3% | 평일 |
| Tuesday | 2,228건 | 18.5% | 평일 |
| Wednesday | 2,325건 | 19.3% | 평일 |
| Thursday | 2,295건 | 19.0% | 평일 |
| Friday | 2,294건 | 19.0% | 평일 |
| Saturday | 709건 | 5.9% | 축소 운영 |
| **Sunday** | **0건** | **0%** | **휴무** |

**분석**:
- 일요일 예약 0건 (운영 규칙 준수)
- 토요일은 평일 대비 1/3 (주말 가능 검사만)
- 평일 균등 분포 (18~19%)

### 5.3 월별 분포

| 월 | 예약 건수 | 비율 |
|----|----------|------|
| 1월 | 1,038건 | 8.6% |
| 2월 | 944건 | 7.8% |
| 3월 | 990건 | 8.2% |
| 4월 | 1,062건 | 8.8% |
| 5월 | 956건 | 7.9% |
| 6월 | 1,014건 | 8.4% |
| 7월 | 1,015건 | 8.4% |
| 8월 | 981건 | 8.1% |
| 9월 | 1,005건 | 8.3% |
| 10월 | 1,010건 | 8.4% |
| 11월 | 981건 | 8.1% |
| 12월 | 1,067건 | 8.8% |

**분석**: 월별 7.8%~8.9% 범위로 균등 분포 (연간 균형)

### 5.4 장비별 분포

| 장비 | 예약 건수 | 비율 | 자원 수 | 자원당 예약 |
|------|----------|------|---------|------------|
| FUNC | 6,247건 | 51.8% | 8대 | 781건 |
| CT | 1,328건 | 11.0% | 4대 | 332건 |
| MRI | 1,182건 | 9.8% | 5대 | 236건 |
| ENDO | 892건 | 7.4% | 5대 | 178건 |
| US | 862건 | 7.1% | 4대 | 216건 |
| NM | 604건 | 5.0% | 4대 | 151건 |
| XRAY | 518건 | 4.3% | 3대 | 173건 |
| FLUORO | 430건 | 3.6% | 3대 | 143건 |

**분석**:
- FUNC(기능검사)가 과반수 (검사 종류 76개로 가장 많음)
- 자원당 예약 수는 장비 특성에 따라 차이 (FUNC는 소요시간 짧음)

### 5.5 환자 분포

| 지표 | 값 | 설명 |
|------|-----|------|
| 환자당 평균 예약 | 4.64건 | 다중 검사 패턴 반영 |
| 최대 예약 건수 | 23건/환자 | 종합검진 케이스 |
| 다중 검사 환자 비율 | 85.5% (2,226명) | 규칙 테스트에 적합 |

**다중 검사 환자 비율이 높은 이유**:
- 실제 병원에서 여러 검사를 함께 처방하는 패턴 반영
- 검사 간 규칙 (순서, 간격) 테스트를 위해 의도적으로 설계

---

## 6. 규칙 검증 결과

### 6.1 검증 스크립트

```bash
python src/verify_reservation.py
```

### 6.2 검증 항목 및 결과

| 규칙 유형 | 설명 | 위반 건수 | 테이블 참조 |
|----------|------|----------|------------|
| 일요일 예약 금지 | 일요일 예약 불가 | **0건** | 운영 규칙 |
| NOWEEKEND | 특정 검사 토요일 제한 | **0건** | EXAM_CONDITION_RULES |
| SAME_DAY_CD=N | 당일 시행 불가 검사쌍 | **0건** | EXAM_RELATION_RULES |
| GAP_VALUE | 검사 간 최소 간격 | **0건** | EXAM_RELATION_RULES |
| SEQ_REQ_YN=Y | 검사 순서 (같은 날) | **0건** | EXAM_RELATION_RULES |
| 자원 충돌 | 동일 자원 시간 중복 | **0건** | 자원 배정 |

**전체 규칙 위반: 0건**

### 6.3 검증 로직 상세

#### SAME_DAY_CD=N 검증
```python
# 같은 환자, 같은 날짜에 SAME_DAY_CD=N인 검사쌍이 있는지 체크
for patient_id, patient_data in reservation.groupby('PATIENT_ID'):
    for date, date_data in patient_data.groupby('RESERVATION_DATE'):
        exam_codes = date_data['EXAM_CD'].tolist()
        for i, exam_a in enumerate(exam_codes):
            for exam_b in exam_codes[i+1:]:
                rule = relation_rules[
                    (relation_rules['EXAM_A'] == exam_a) &
                    (relation_rules['EXAM_B'] == exam_b) &
                    (relation_rules['SAME_DAY_CD'] == 'N')
                ]
                if len(rule) > 0:
                    violations.append(...)
```

#### GAP_VALUE 검증
```python
# 검사 간 간격이 GAP_VALUE 이상인지 체크
for patient_id, patient_data in reservation.groupby('PATIENT_ID'):
    exams_sorted = patient_data.sort_values('RESERVATION_DATETIME')
    for i, exam1 in exams_sorted.iterrows():
        for j, exam2 in exams_sorted.iterrows():
            if exam1['RESERVATION_DATETIME'] < exam2['RESERVATION_DATETIME']:
                rule = get_gap_rule(exam1['EXAM_CD'], exam2['EXAM_CD'])
                if rule:
                    actual_gap = exam2['RESERVATION_DATETIME'] - exam1['RESERVATION_DATETIME']
                    required_gap = convert_gap(rule['GAP_VALUE'], rule['GAP_UNIT'])
                    if actual_gap < required_gap:
                        violations.append(...)
```

#### SEQ_REQ_YN=Y 검증
```python
# 같은 날, 같은 환자에서 순서 규칙 검증
# EXAM_A가 EXAM_B보다 먼저 시행되어야 함
for patient_id, patient_data in reservation.groupby('PATIENT_ID'):
    for date, date_data in patient_data.groupby('RESERVATION_DATE'):
        exams_in_order = date_data.sort_values('RESERVATION_DATETIME')['EXAM_CD'].tolist()
        for _, rule in seq_rules.iterrows():
            if rule['EXAM_A'] in exams_in_order and rule['EXAM_B'] in exams_in_order:
                idx_a = exams_in_order.index(rule['EXAM_A'])
                idx_b = exams_in_order.index(rule['EXAM_B'])
                if idx_a > idx_b:  # B가 A보다 먼저
                    violations.append(...)
```

---

## 7. 임상적 타당성

### 7.1 시간대 적절성

| 검사 | 시간대 | 평가 | 근거 |
|------|--------|------|------|
| PSG (수면다원검사) | 21시 100% | ✓ | 야간 검사 특성 |
| MSLT (주간졸림검사) | 08시 95% | ✓ | PSG 다음날 오전 시작 |
| 내시경 | 오전 집중 | ✓ | 금식 환자 배려 |
| PET | 오전 집중 | ✓ | 당뇨환자 오전 예약 규칙 |

### 7.2 검사 조합 (함께 시행되는 검사)

| 조합 | 검사들 | 규칙 적용 |
|------|--------|----------|
| 청력검사 세트 | PTA + Speech Audiometry + IA | 같은 날 연속 배치 |
| 치매검사 세트 | MMSE + CDR | 같은 날 연속 배치 |
| 자율신경검사 세트 | 기립경사 + 발살바 + 심박동 | 같은 날 연속 배치 |
| 수면검사 세트 | PSG → MSLT | 순서 필수, 1일 간격 |
| 내시경 세트 | 위내시경 + 대장내시경 | 같은 날 가능 |

### 7.3 다중 예약 패턴

| 동시예약 건수 | 발생 횟수 | 예시 |
|-------------|----------|------|
| 2건 | 1,094회 | CT + 초음파 |
| 3건 | 344회 | CT + MRI + 초음파 |
| 4건 | 189회 | 종합검진 기본 |
| 5건+ | 145회 | 종합검진 패키지 |

---

## 8. 자원 배정 알고리즘

### 8.1 배정 로직

```python
# 날짜별, 장비유형별로 처리
for date in dates:
    for equipment_type in equipment_types:
        # 해당 장비의 자원 목록
        resources = resource_master[resource_master['EQUIPMENT_TYPE'] == equipment_type]

        # 각 자원별 종료 시간 추적
        resource_end_times = {res_id: datetime.min for res_id in resources['RESOURCE_ID']}

        # 해당 날짜, 장비의 예약 시간순 처리
        day_reservations = reservation[
            (reservation['RESERVATION_DATE'] == date) &
            (reservation['EQUIPMENT_TYPE'] == equipment_type)
        ].sort_values('RESERVATION_DATETIME')

        for _, res in day_reservations.iterrows():
            start_time = res['RESERVATION_DATETIME']
            duration = res['DURATION_MIN']
            end_time = start_time + timedelta(minutes=duration)

            # 시작 시간 이전에 종료된 자원 찾기
            available = [r for r in resource_end_times
                        if resource_end_times[r] <= start_time]

            if available:
                selected = available[0]  # 첫 번째 가용 자원
                reservation.loc[res.name, 'RESOURCE_ID'] = selected
                resource_end_times[selected] = end_time
```

### 8.2 자원 충돌 해결 과정

초기 생성 시 발생한 충돌:

| 장비 | 초기 자원 수 | 최종 자원 수 | 조정 사유 | 피크 시점 |
|------|------------|------------|-----------|----------|
| US | 3대 | 4대 | 동일 시간대 4건 동시 | 2026-01-17 09:36 |
| XRAY | 2대 | 3대 | 동일 시간대 3건 동시 | 2026-01-21 09:30 |

**자원 충돌 검증**:
```python
# 동일 자원에 시간이 겹치는 예약이 있는지 확인
for resource_id in resources:
    res_reservations = reservation[reservation['RESOURCE_ID'] == resource_id]
    for i, res1 in res_reservations.iterrows():
        for j, res2 in res_reservations.iterrows():
            if i < j:
                end1 = res1['RESERVATION_DATETIME'] + timedelta(minutes=res1['DURATION_MIN'])
                start2 = res2['RESERVATION_DATETIME']
                if end1 > start2:
                    conflicts.append(...)
```

---

## 9. 룰엔진 테스트

### 9.1 테스트 시나리오

신규 환자(P999999)에게 4개 검사 처방:

| 검사 코드 | 검사명 | 장비 | 소요시간 |
|-----------|--------|------|----------|
| RC060003 | Abdomen CT (CE) | CT | 20분 |
| RM010029 | (3T)MRI-Liver (CE) + DWI | MRI | 45분 |
| RU010003 | Abdomen 정밀 초음파 | US | 20분 |
| SC030010 | colon-Fiberscopy | ENDO | 30분 |

### 9.2 적용된 규칙

| 규칙 | 내용 | 근거 |
|------|------|------|
| SC030010 → RC060003 | 대장내시경 먼저 | SEQ_REQ_YN=Y, SEDATION |
| 60분 간격 | 내시경-CT 간 최소 간격 | GAP_VALUE=60, GAP_UNIT=M |
| SAME_DAY_CD=C | 당일 시행 가능 | 같은 날 또는 간격 준수 |

### 9.3 스케줄링 결과

| 날짜 | 시간 | 검사 | 자원 | 비고 |
|------|------|------|------|------|
| 2026-02-02 | 08:00~08:30 | SC030010 (대장내시경) | ENDO_01 | 첫 번째 (순서 규칙) |
| 2026-02-02 | 09:00~09:20 | RC060003 (복부CT조영) | CT_01 | 60분 후 (간격 규칙) |
| 2026-02-03 | 08:00~08:45 | RM010029 (간MRI) | MRI_01 | 다음 날 배치 |
| 2026-02-03 | 09:00~09:20 | RU010003 (복부초음파) | US_01 | MRI 후 배치 |

### 9.4 기존 예약과 충돌 검증

```python
# 신규 4건 예약이 기존 12,063건과 충돌하는지 확인
for new_res in new_reservations:
    conflicts = existing[
        (existing['RESOURCE_ID'] == new_res['RESOURCE_ID']) &
        (existing['RESERVATION_DATE'] == new_res['RESERVATION_DATE']) &
        (overlaps(existing, new_res))
    ]
    assert len(conflicts) == 0, f"충돌 발생: {conflicts}"
```

**결과**: 4건 모두 충돌 없음 ✓

---

## 10. 생성 스크립트

### 10.1 스크립트 목록

| 스크립트 | 기능 | 위치 |
|----------|------|------|
| generate_reservation.py | 예약 데이터 생성 | src/ |
| assign_resource.py | 자원 배정 | src/ |
| verify_reservation.py | 규칙 위반 검증 | src/ |
| generate_schedule_html.py | HTML 시간표 생성 | src/ |

### 10.2 실행 순서

```bash
# 1. 예약 데이터 생성 (v2 - 골고루 분배 버전)
python src/generate_reservation.py

# 2. 자원 배정
python src/assign_resource.py

# 3. 규칙 검증
python src/verify_reservation.py

# 4. HTML 뷰어 생성
python src/generate_schedule_html.py
```

### 10.3 생성된 파일

| 파일 | 경로 | 설명 |
|------|------|------|
| RESERVATION.csv | data/ | 예약 데이터 (12,063건) |
| RESOURCE.csv | data/ | 자원 마스터 (36대) |
| schedule_viewer.html | web/ | 예약 시간표 뷰어 |

---

## 11. 웹 뷰어 기능

### 11.1 일간 뷰

- 모든 장비 가로 배치
- 10분 단위 그리드
- 장비별 색상 구분
- 시간 열 고정 (sticky)

### 11.2 주간 뷰

- 7일간 장비별 표시
- 30분 단위 그리드
- 날짜 클릭 시 해당일로 이동

### 11.3 시간 범위

| 장비 | 시간 범위 | 비고 |
|------|----------|------|
| FUNC | 08:00~22:00 | PSG 포함 (21:00) |
| 기타 | 08:00~16:00 | 일반 운영 시간 |

### 11.4 장비별 색상

| 장비 | 색상 | HEX |
|------|------|-----|
| CT | 초록 | #4CAF50 |
| MRI | 파랑 | #2196F3 |
| US | 주황 | #FF9800 |
| NM | 보라 | #9C27B0 |
| ENDO | 분홍 | #E91E63 |
| FUNC | 청록 | #00BCD4 |
| XRAY | 갈색 | #795548 |
| FLUORO | 회색 | #607D8B |

---

## 12. 데이터 품질 요약

| 지표 | 값 | 평가 |
|-----|-----|------|
| 검사 커버리지 | 264/264개 (100%) | ✓ 우수 |
| 규칙 위반 | 0건 | ✓ 완벽 준수 |
| 자원 충돌 | 0건 | ✓ 충돌 없음 |
| 시간대 분포 | 08시~21시 | ✓ 현실적 |
| 요일 분포 | 평일 균등, 토요일 축소, 일요일 0건 | ✓ 현실적 |
| 참조 무결성 (EXAM_CD) | 100% | ✓ 통과 |
| 참조 무결성 (RESOURCE_ID) | 100% | ✓ 통과 |

---

## 13. 테스트 시나리오 설계

### 13.1 시나리오 분류

| 분류 | 검사 수 | 케이스 수 | 설명 |
|------|---------|----------|------|
| A. 같은 날 필수 | 2-3개 | 5개 | SAME_DAY_CD=Y 검증 |
| B. 간격 필요 | 2개 | 5개 | GAP_VALUE 검증 |
| C. 순서 필요 | 2개 | 3개 | SEQ_REQ_YN=Y 검증 |
| D. 복합 케이스 | 3-5개 | 5개 | 여러 규칙 조합 |
| E. 리소스 충돌 | 2-3개 | 3개 | 같은 장비 시간 겹침 |
| **합계** | - | **21개** | - |

### 13.2 대표 테스트 시나리오

| ID | 검사 목록 | 규칙 | 예상 결과 |
|----|----------|------|----------|
| TS_A01 | SC030005, SC030010 | 위내시경→대장내시경 | 두 검사 같은 날 배치 |
| TS_B01 | RC060003, RX010001 | Abdomen CT → BMD 3일 | 3일 이상 간격 |
| TS_C01 | SC030010, RC060003 | 대장내시경 → Abdomen CT | 순서 유지 + 60분 간격 |
| TS_D01 | SC030005, SC030010, RC060003 | 내시경 같은날 + CT 순서 | Day1: 내시경2개, +60분: CT |

---

## 14. 한계점

1. **조건 규칙 미적용**: 환자 연령, 질환 등 EXAM_CONDITION_RULES는 메타데이터로만 반영 (실제 환자 정보 없음)
2. **실제 패턴 차이**: 합성 데이터로 실제 병원 예약 패턴과 다를 수 있음
3. **장비 집중**: 특정 장비(FUNC)에 예약 집중 (검사 종류가 많아서)
4. **시술 미포함**: Biopsy 등 시술 카테고리는 범위 외

---

*최종 업데이트: 2025-12-24*
