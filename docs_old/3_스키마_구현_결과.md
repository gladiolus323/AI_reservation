# 스키마 구현 결과 보고서

**작성일**: 2025-12-29

---

## 1. 개요

본 문서는 검사 예약 규칙 정형화 스키마의 **실제 구현 결과**를 기술합니다.
설계 계획서(2_스키마_설계.md)를 기반으로 구현한 최종 데이터 현황과 매뉴얼 규칙 커버리지를 보고합니다.

### 1.1 문서 구분

| 문서 | 성격 | 작성일 |
|------|------|--------|
| 2_스키마_설계.md | 설계 계획서 | 2025-12-24 |
| **3_스키마_구현_결과.md** | **구현 결과 보고서** | **2025-12-29** |

### 1.2 구현 범위

| 항목 | 내용 |
|------|------|
| 입력 자료 | 통합 검사예약업무 매뉴얼.pdf (38페이지, 170개 규칙) |
| 구현 테이블 | EXAM_MASTER, EXAM_RELATION_RULES, EXAM_CONDITION_RULES |
| 데이터 위치 | `data/` 폴더 내 CSV 파일 |

---

## 2. 구현 현황 요약

### 2.1 테이블별 구현 건수

| 테이블 | 설계 목표 | 실제 구현 | 비고 |
|--------|----------|----------|------|
| EXAM_MASTER | 265개 | **264개** | 검사 기본 정보 |
| EXAM_RELATION_RULES | 88개 | **86개** | 검사 간 관계 규칙 |
| EXAM_CONDITION_RULES | 47개 | **47개** | 조건부 규칙 |

### 2.2 매뉴얼 규칙 정형화 현황

| 분류 | 건수 | 비율 | 상태 |
|------|------|------|------|
| **정형화 완료** | 139개 | 81.8% | ✅ 스키마로 표현 |
| 로직 구현 필요 | 14개 | 8.2% | ⚠️ 코드 구현 |
| 정형화 불필요 | 17개 | 10.0% | - 임시 공지/운영 지침 |
| **합계** | **170개** | **100%** | |

### 2.3 정형화율

```
매뉴얼 전체 규칙 (170개):
████████████████████████████████░░░░░░░░ 139/170개 (81.8%) 정형화 완료
```

---

## 3. EXAM_MASTER 구현 결과

### 3.1 기본 현황

| 항목 | 값 |
|------|-----|
| 총 검사 수 | 264개 |
| 컬럼 수 | 14개 |

### 3.2 컬럼 구성

| 컬럼명 | 타입 | 필수 | 설명 | 활용 건수 |
|--------|------|------|------|----------|
| EXAM_CD | VARCHAR(20) | Y | 검사코드 (PK) | 264 |
| EXAM_NM | VARCHAR(200) | Y | 검사명 | 264 |
| DURATION_MIN | INT | Y | 소요시간(분) | 264 |
| PREP_MIN | INT | N | 사전준비시간(분) | - |
| WALK_IN_POLICY | CHAR(1) | N | 예약없이 방문 시 | - |
| RESULT_DAYS | INT | N | 결과 소요일 | - |
| FASTING_HRS | INT | N | 금식시간 | 조영제 검사 |
| CONTRAST_YN | CHAR(1) | N | 조영제 사용 | 264 |
| SEDATION_YN | CHAR(1) | N | 진정검사 | 264 |
| MIN_AGE | DECIMAL | N | 최소연령 | - |
| MAX_AGE | DECIMAL | N | 최대연령 | - |
| AVAIL_START_TIME | TIME | N | 검사 가능 시작 | PSG 등 |
| AVAIL_END_TIME | TIME | N | 검사 가능 종료 | PSG 등 |
| EQUIPMENT_TYPE | VARCHAR(10) | N | 장비 유형 | 264 |

### 3.3 장비 유형별 분포

| EQUIPMENT_TYPE | 검사 수 | 비율 |
|----------------|--------|------|
| FUNC | 76개 | 28.8% |
| CT | 67개 | 25.4% |
| MRI | 65개 | 24.6% |
| US | 29개 | 11.0% |
| NM | 11개 | 4.2% |
| ENDO | 9개 | 3.4% |
| FLUORO | 4개 | 1.5% |
| XRAY | 3개 | 1.1% |
| **합계** | **264개** | **100%** |

### 3.4 시간 제한 검사 (AVAIL_TIME)

| 검사코드 | 검사명 | 시작 | 종료 | 특징 |
|---------|--------|------|------|------|
| SC070001 | PSG (수면다원검사) | 21:00 | 06:00 | 야간 전용 |
| SC070002 | MSLT (주간졸림검사) | 08:30 | 17:00 | 주간 전용 |

---

## 4. EXAM_RELATION_RULES 구현 결과

### 4.1 기본 현황

| 항목 | 값 |
|------|-----|
| 총 규칙 수 | 86개 |
| 컬럼 수 | 9개 |

### 4.2 컬럼 구성

| 컬럼명 | 타입 | 필수 | 설명 |
|--------|------|------|------|
| EXAM_A | VARCHAR(20) | Y | 선행 검사코드 |
| EXAM_B | VARCHAR(20) | Y | 후행 검사코드 |
| SEQ_REQ_YN | CHAR(1) | Y | 순서 필수 (Y/N) |
| SAME_DAY_CD | CHAR(1) | Y | 당일시행 (Y/N/C) |
| GAP_VALUE | INT | N | 간격 수치 |
| GAP_UNIT | CHAR(1) | N | 간격 단위 (D/H/M) |
| REV_GAP_VALUE | INT | N | 역방향 간격 수치 |
| REV_GAP_UNIT | CHAR(1) | N | 역방향 간격 단위 |
| REASON_CD | VARCHAR(20) | N | 제한 사유 코드 |

### 4.3 SAME_DAY_CD 분포

| 코드 | 의미 | 건수 | 비율 |
|------|------|------|------|
| N | 당일 시행 불가 | 55건 | 64.0% |
| C | 조건부 가능 | 19건 | 22.1% |
| Y | 당일 시행 필수/가능 | 12건 | 14.0% |
| **합계** | | **86건** | **100%** |

### 4.4 SEQ_REQ_YN 분포

| 코드 | 의미 | 건수 | 비율 |
|------|------|------|------|
| N | 순서 무관 | 64건 | 74.4% |
| Y | 순서 필수 | 22건 | 25.6% |
| **합계** | | **86건** | **100%** |

### 4.5 REASON_CD 분포

| 코드 | 의미 | 건수 | 비율 |
|------|------|------|------|
| (없음) | 일반 규칙 | 63건 | 73.3% |
| CONTRAST | 조영제 관련 | 14건 | 16.3% |
| SEDATION | 진정 관련 | 3건 | 3.5% |
| FASTING | 금식 관련 | 2건 | 2.3% |
| BOWEL | 장정결 관련 | 2건 | 2.3% |
| RADIATION | 방사선 관련 | 2건 | 2.3% |
| **합계** | | **86건** | **100%** |

### 4.6 GAP 규칙 현황

| 구분 | 건수 |
|------|------|
| GAP_VALUE 있음 | 45건 |
| GAP_VALUE 없음 | 41건 |
| REV_GAP_VALUE 있음 (양방향 간격) | 5건 |

**GAP_UNIT 분포**:
| 단위 | 의미 | 건수 |
|------|------|------|
| D | 일 | 30건 |
| M | 분 | 13건 |
| H | 시간 | 2건 |

---

## 5. EXAM_CONDITION_RULES 구현 결과

### 5.1 기본 현황

| 항목 | 값 |
|------|-----|
| 총 규칙 수 | 47개 |
| 고유 RULE_ID 수 | 20개 |
| 컬럼 수 | 7개 |

### 5.2 컬럼 구성

| 컬럼명 | 타입 | 필수 | 설명 |
|--------|------|------|------|
| RULE_ID | VARCHAR(10) | Y | 규칙ID |
| EXAM_CD | VARCHAR(20) | Y | 검사코드 |
| COND_TYPE | VARCHAR(20) | Y | 조건유형 |
| COND_OP | VARCHAR(10) | Y | 연산자 |
| COND_VAL | VARCHAR(100) | Y | 조건값 |
| ACTION_CD | VARCHAR(20) | Y | 조치코드 |
| ACTION_VAL | VARCHAR(200) | N | 조치상세 |

### 5.3 COND_TYPE 분포

| 조건유형 | 의미 | 건수 | 비율 | 대표 규칙 |
|----------|------|------|------|----------|
| AGE | 연령 | 17건 | 36.2% | 소아 보호자동반, 시간제한, 금식 |
| MED | 복용약 | 10건 | 21.3% | Metformin/Aspirin 중단, 인슐린 금지 |
| WEEKDAY | 요일 | 7건 | 14.9% | 주말 불가, 토요일 오전만 |
| ALLERGY | 알레르기 | 4건 | 8.5% | 조영제 알레르기 동의서 |
| DISEASE | 질환 | 4건 | 8.5% | 당뇨 오전예약, 투석 후처치 |
| PREG | 임신 | 2건 | 4.3% | 임산부 조영제 미사용 |
| DEVICE | 의료기기 | 2건 | 4.3% | 심박동기 MRI 시간제한 |
| INTERVAL | 검사간격 | 1건 | 2.1% | BMD 11개월 비급여 |
| **합계** | | **47건** | **100%** | |

### 5.4 ACTION_CD 분포

| 조치코드 | 의미 | 건수 | 비율 |
|----------|------|------|------|
| TIMEONLY | 특정 시간만 가능 | 13건 | 27.7% |
| FASTING | 금식 필요 | 10건 | 21.3% |
| STOPMED | 복약 중단 필요 | 8건 | 17.0% |
| NOWEEKEND | 주말 불가 | 5건 | 10.6% |
| GUARD | 보호자 동반 필수 | 5건 | 10.6% |
| CONSENT | 동의서 필수 | 4건 | 8.5% |
| PRETEST | 사전 조치 필요 | 2건 | 4.3% |
| **합계** | | **47건** | **100%** |

### 5.5 RULE_ID별 상세

| RULE_ID | 건수 | 조건 | 액션 | 설명 |
|---------|------|------|------|------|
| R001 | 5건 | AGE < 19 | GUARD | 19세 미만 조영제 검사 보호자 동반 |
| R002 | 3건 | AGE <= 15 | TIMEONLY | 소아 CT 오후 2~3시만 |
| R003 | 3건 | AGE <= 15 | TIMEONLY | 소아 MRI 9:30~15:30 |
| R004 | 3건 | WEEKDAY IN 토/일 | NOWEEKEND | CT 조영제 주말 불가 |
| R005 | 2건 | WEEKDAY IN 토/일 | NOWEEKEND | MRI 조영제 주말 불가 |
| R006 | 3건 | MED STOP Metformin | STOPMED | CT 전후 2일 중단 |
| R007 | 1건 | MED STOP Metformin(IMC) | STOPMED | 3일 중단 |
| R008 | 4건 | MED STOP Aspirin | STOPMED | 내시경 5~7일 중단 |
| R009 | 4건 | ALLERGY = Y | CONSENT | 조영제 알레르기 동의서 |
| R010 | 2건 | PREG = Y | FASTING | 임산부 조영제 미사용 |
| R011 | 2건 | DEVICE = 심박동기 | TIMEONLY | MRI 평일 근무시간만 |
| R012 | 2건 | DISEASE = 당뇨 | TIMEONLY | PET 오전 예약 필수 |
| R013 | 2건 | MED != 인슐린당일 | FASTING | 검사 당일 인슐린 금지 |
| R014 | 1건 | AGE <= 0.1 | FASTING | 신생아 4시간 금식 |
| R015 | 2건 | AGE <= 15 | FASTING | 소아 6시간 금식 |
| R016 | 2건 | AGE > 15 | FASTING | 성인 8시간 금식 |
| R017 | 2건 | WEEKDAY = 토요일 | TIMEONLY | MRI 토요일 오전만 |
| R018 | 1건 | INTERVAL < 11M | FASTING | BMD 11개월 이내 비급여 |
| R019 | 1건 | AGE <= 0.33 | TIMEONLY | 4개월 이전만 가능 |
| R020 | 2건 | DISEASE = 투석 | PRETEST | CT 후 투석 필요 |

---

## 6. 설계 대비 구현 변경 사항

### 6.1 정형화 방식 변경

설계 계획서에서 "로직 구현 필요"로 분류했으나, 실제로는 테이블로 정형화한 규칙:

| 규칙 | 설계 분류 | 실제 구현 | 변경 사유 |
|------|----------|----------|----------|
| BMD 11개월 이내 비급여 | 로직 구현 필요 | COND_TYPE=INTERVAL | 조건 정의는 테이블, 검사일 조회는 룰엔진 |

### 6.2 정형화 방식 해석

**설계 계획서 기준**:
- "마지막 검사일 조회"가 필요하므로 100% 테이블 정형화 불가
- → 로직 구현 필요로 분류

**실제 구현 기준**:
- **규칙 정의**: 테이블 (COND_TYPE=INTERVAL, COND_VAL=11M)
- **규칙 실행**: 룰 엔진 코드 (검사일 조회 로직)
- → 규칙 자체는 정형화 완료

### 6.3 최종 분류 조정

| 분류 | 설계 계획 | 실제 구현 | 조정 |
|------|----------|----------|------|
| 정형화 완료 | 99개 | **100개** | +1 |
| 로직 구현 필요 | 15개 | **14개** | -1 |

---

## 7. 로직 구현 필요 규칙 (14개)

테이블 정형화가 **불가능**하여 프로그램 코드로만 구현해야 하는 규칙:

### 7.1 시간 기반 동적 계산 (5개)

| 규칙 | 필요 로직 |
|------|----------|
| 위내시경 오후 시 8시간 금식 계산 | 검사시간 기준 역산 |
| Coronary CT 후 1시간30분 뒤 다음검사 | 맥박조절 대기시간 계산 |
| Holter 기계 제거일 계산 | 부착일+일수 (주말 고려) |
| 72시간 Holter 결과 15일 후 | 기계 부착일 기준 |
| 진료시간 기준 검사예약 시간 계산 | RTC 시간 기반 역산 |

### 7.2 캘린더/스케줄 조회 (3개)

| 규칙 | 필요 로직 |
|------|----------|
| RTC 일주일 전 예약 (공휴일 제외) | 공휴일 마스터 + 영업일 계산 |
| MSLT 수면다원 다음날 8:30 예약 | 토/공휴일 제외 검증 |
| 핵의학 검사 3시반~4시반 이후 예약 불가 | 약물 준비 시간 체크 |

### 7.3 복합 조건 처리 (3개)

| 규칙 | 필요 로직 | 비고 |
|------|----------|------|
| 복합 처방 시 최대 금식시간 적용 | 여러 검사 MAX 연산 | |
| 같은 날 CT 여러개 시 contrast 1개만 과금 | 처방 순회 + 과금 로직 | |
| CT entero + 대장내시경 약 설명 분기 | 검사조합별 분기 | |

### 7.4 텍스트 파싱 (3개)

| 규칙 | 필요 로직 |
|------|----------|
| CT 장정결제(쿨프렙) 처방 확인 | Remark 키워드 파싱 |
| 내시경 직접 메모 시 교수방 자동 배정 | Remark + 스케줄 매칭 |
| 슬롯 부족 시 검사실 통화 필요 알림 | 실시간 슬롯 조회 |

---

## 8. 데이터 품질 검증

### 8.1 테이블별 검증 결과

| 테이블 | 건수 | 오류 | 경고 | 판정 |
|--------|------|------|------|------|
| EXAM_MASTER | 264 | 0 | 0 | **PASS** |
| EXAM_RELATION_RULES | 86 | 0 | 18 | **PASS** |
| EXAM_CONDITION_RULES | 47 | 0 | 0 | **PASS** |

### 8.2 경고 사항

**SAME_DAY_CD=N인데 GAP_VALUE 없음 (18건)**:
- 해석 규칙: "당일 불가 + GAP_VALUE=NULL → 기본 1일 간격"
- 룰 엔진에서 기본값 처리

### 8.3 외래키 검증

| 검증 항목 | 결과 |
|-----------|------|
| EXAM_A → EXAM_MASTER | **100% 통과** |
| EXAM_B → EXAM_MASTER | **100% 통과** |
| EXAM_CD → EXAM_MASTER | **100% 통과** |

### 8.4 코드값 유효성

| 컬럼 | 허용값 | 결과 |
|------|--------|------|
| SEQ_REQ_YN | Y, N | **통과** |
| SAME_DAY_CD | Y, N, C | **통과** |
| GAP_UNIT | M, H, D | **통과** |
| COND_OP | <, <=, >, >=, =, !=, IN, STOP | **통과** |

---

## 9. 매뉴얼 규칙 커버리지 및 용도 분류

매뉴얼 170개 규칙을 **정형화 여부**와 **예약 시스템 용도**로 분류합니다.

### 9.1 전체 현황 (매뉴얼 170개 규칙 기준)

| 분류 | 건수 | 비율 | 상태 |
|------|------|------|------|
| **정형화 완료** | 139개 | 81.8% | ✅ 스키마로 표현 |
| 로직 구현 필요 | 14개 | 8.2% | ⚠️ 코드 구현 |
| 정형화 불필요 | 17개 | 10.0% | - 임시 공지/운영 지침 |
| **합계** | **170개** | **100%** | |

### 9.2 정형화 규칙의 스키마별 분류 (139개)

| 스키마 테이블 | 규칙 유형 | 건수 | 비율 |
|--------------|----------|------|------|
| EXAM_RELATION_RULES | 검사 간 관계 (순서, 간격, 당일가능) | 64개 | 46.0% |
| EXAM_CONDITION_RULES | 조건부 규칙 (연령, 약물, 요일 등) | 54개 | 38.8% |
| EXAM_MASTER | 검사 속성 (소요시간, 금식, 연령제한 등) | 21개 | 15.1% |
| **합계** | | **139개** | 100% |

### 9.3 정형화 규칙의 용도별 분류 (139개)

| 용도 | 관계 규칙 | 조건 규칙 | 검사 속성 | 합계 | 비율 |
|------|----------|----------|----------|------|------|
| **스케줄링** | 64개 | 30개 | 21개 | **115개** | 82.7% |
| **안내/준비** | - | 23개 | - | **23개** | 16.5% |
| **과금** | - | 1개 | - | **1개** | 0.7% |
| **합계** | **64개** | **54개** | **21개** | **139개** | 100% |

### 9.4 예약 시스템 활용 관점 종합

| 구분 | 건수 | 예약 시스템 | 비고 |
|------|------|------------|------|
| 스케줄링 규칙 | 115개 | ✅ 필수 적용 | 시간/순서/간격 결정 |
| 안내/준비 규칙 | 23개 | ⚠️ 알림 용도 | 금식, 약물중단, 동의서 등 |
| 과금 규칙 | 1개 | ❌ 수납 시스템 | BMD 비급여 |
| 로직 구현 필요 | 14개 | ⚠️ 코드 구현 | 동적 계산, 캘린더 조회 등 |
| 정형화 불필요 | 17개 | - | 임시 공지, 운영 지침 |
| **합계** | **170개** | | |

### 9.5 커버리지 시각화

```
매뉴얼 전체 규칙 (170개):
├─ 정형화 완료 (139개, 81.8%)
│   ├─ 스케줄링 (115개) ████████████████████████████████░░░░░░░░ 82.7%
│   ├─ 안내/준비 (23개)  ██████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░ 16.5%
│   └─ 과금 (1개)        ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░  0.7%
├─ 로직 구현 필요 (14개, 8.2%)
└─ 정형화 불필요 (17개, 10.0%)
```

### 9.6 용도별 분류 기준

| 용도 | 설명 | 예약 시스템 영향 |
|------|------|-----------------|
| **스케줄링** | 검사 시간/순서/간격 결정에 직접 영향 | ✅ 필수 적용 |
| **안내/준비** | 환자/의료진에게 안내할 사항 | ⚠️ 알림 용도 |
| **과금** | 비용 계산 관련 (예약과 무관) | ❌ 별도 시스템 |

### 9.7 조건 규칙 상세 분류 (54개)

| ACTION_CD | 용도 | 건수 | 예약 시스템 활용 |
|-----------|------|------|-----------------|
| TIMEONLY | 스케줄링 | 13건 | ✅ 예약 가능 시간대 제한 |
| NOWEEKEND | 스케줄링 | 5건 | ✅ 주말 예약 차단 |
| FASTING | 안내/준비 | 10건 | ⚠️ 금식 안내 |
| STOPMED | 안내/준비 | 8건 | ⚠️ 복약 중단 안내 |
| GUARD | 안내/준비 | 5건 | ⚠️ 보호자 동반 안내 |
| CONSENT | 안내/준비 | 4건 | ⚠️ 동의서 필요 안내 |
| PRETEST | 안내/준비 | 2건 | ⚠️ 사전 조치 안내 |
| **합계** | | **47건** | |

> **참고**: EXAM_CONDITION_RULES 테이블에는 47건(20개 RULE_ID)이 구현되어 있습니다. 이는 하나의 규칙이 여러 검사코드에 적용되기 때문입니다. 매뉴얼에서 식별한 조건부 규칙 54개 중 현재 스키마로 커버 가능한 규칙들입니다.

### 9.8 과금 규칙 상세

예약 시스템에서 **사용하지 않는** 규칙:

| RULE_ID | 검사 | 조건 | 액션 | 비고 |
|---------|------|------|------|------|
| R018 | RX010001 (BMD) | INTERVAL < 11M | 비급여전환 | 수납 시스템에서 처리 |

> 이 규칙은 매뉴얼에 포함되어 있어 정형화했으나, 예약 가능 여부나 시간 배치에는 영향을 주지 않습니다. 11개월 이내 재검사도 예약은 가능하며, 비급여 여부는 수납 시점에 결정됩니다.

---

## 10. 결론

### 10.1 구현 완료 현황

| 항목 | 결과 |
|------|------|
| 테이블 구현 | 3개 테이블 완료 |
| 검사 마스터 | 264개 검사 등록 |
| 관계 규칙 | 86개 레코드 (64개 규칙 커버) |
| 조건 규칙 | 47개 레코드 (54개 규칙 커버) |
| 검사 속성 규칙 | 21개 (EXAM_MASTER 컬럼으로 표현) |
| **정형화율** | **139/170개 (81.8%)** |

### 10.2 스키마 커버리지 요약

| 스키마 테이블 | 담당 규칙 | 커버 규칙 수 |
|--------------|----------|-------------|
| EXAM_MASTER | 검사 속성 (소요시간, 금식, 연령제한 등) | 21개 |
| EXAM_RELATION_RULES | 검사 간 관계 (순서, 당일가능, 간격) | 64개 |
| EXAM_CONDITION_RULES | 조건부 규칙 (연령, 약물, 요일 등) | 54개 |
| **합계** | | **139개** |

### 10.3 향후 과제

1. **로직 구현 필요 규칙 14개**: 룰 엔진 코드로 구현 필요
2. **시간 규칙 확장**: 검사실별 운영 시간 테이블 추가 검토
3. **교수 스케줄 연동**: PROFESSOR_SCHEDULE 테이블 설계 검토

---

*작성일: 2025-12-29*
